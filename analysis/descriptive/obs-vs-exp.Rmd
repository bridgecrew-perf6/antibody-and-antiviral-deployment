---
title: Assessing inequalities in patients treated with a nMABs and antivirals for COVID 19
output:
  html_document:
  theme: journal
github_document:
  keep_html: TRUE
---
  
```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}
pre[class] {
  max-height: 200px;
}
```

<style>
  body {
    text-align: justify;
     font-size: 11pt}
</style>

  
```{r setup, include=FALSE}
# Document settings ----
knitr::opts_chunk$set(echo = TRUE)

# Preliminaries ----

## Import libraries
library(tidyverse)
library(here)
library(glue)
library(gt)
library(gtsummary)
library(reshape2)
library(stringr)
library(scales)
library(kableExtra)
library(knitr)
library(ggplot2)
library(png)
library(readr)
library(htmltools)
library(pROC)
library(mgcv)
library(gridExtra)
library(cowplot)
library(ggpubr)

## Import custom user functions
source(here("analysis", "lib", "custom_functions.R"))

## Output directory
output_dir_rmd <- here("reports", "variation")
fs::dir_create(output_dir_rmd)

## Redaction threshold
threshold = 8

## Import data
data_processed <- read_rds(here::here("output", "data", "data_processed_clean.rds"))

## Remove patients no longer registered at time of treatment and format variables
data_processed_clean <- data_processed %>%
  filter(has_died == 0,
         registered_eligible == 1 | registered_treated == 1) %>%
  mutate(across(
    .cols = c(downs_syndrome, solid_cancer, haematological_disease, renal_disease, liver_disease, imid, immunosupression, 
              hiv_aids, solid_organ_transplant, rare_neurological_conditions, autism_nhsd, care_home_primis, dementia_nhsd, 
              housebound_opensafely, learning_disability_primis, shielded_primis, serious_mental_illness_nhsd, sickle_cell_disease_nhsd),
    .fns = ~as.factor(replace_na(., 0))
  )) %>%
  mutate(
    
    age = as.numeric(age),
    
    high_risk_group_combined_count = as.numeric(high_risk_group_combined_count),
    high_risk_group_combined_count = ifelse(high_risk_group_combined_count > 7, 7, high_risk_group_combined_count),
    
    vaccination_status = fct_case_when(
      vaccination_status == "Un-vaccinated" ~ "Un-vaccinated",
      vaccination_status == "Un-vaccinated (declined)" ~ "Un-vaccinated (declined)",
      vaccination_status== "One vaccination" ~ "One vaccination",
      vaccination_status == "Two vaccinations" ~ "Two vaccinations",
      vaccination_status == "Three or more vaccinations" ~ "Three or more vaccinations",
      #TRUE ~ "Unknown",
      TRUE ~ NA_character_
    ),
    
    treated_observed = ifelse(!is.na(treatment_date), 1, 0),
    
    ageband = cut(
      age,
      breaks = c(12, 30, 40, 50, 60, 70, 80, Inf),
      labels = c("12-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+"),
      right = FALSE),
    
    days_since_test_positive = as.numeric(as.Date("2021-12-16") - covid_test_positive_date),
    
    week = lubridate::week(covid_test_positive_date) + 3,
    week = ifelse(week %in% c(53:55), week - 53, week)
    
    ) 

# Model variables
variables = c("ageband","sex", "ethnicity", "imd", "rural_urban", "region_nhs", "stp", "downs_syndrome", "solid_cancer", 
              "haematological_disease", "renal_disease", "liver_disease", "imid", "immunosupression", "hiv_aids", "solid_organ_transplant", 
              "rare_neurological_conditions", "autism_nhsd", "care_home_primis", "dementia_nhsd", 
              "housebound_opensafely", "learning_disability_primis", "shielded_primis", "serious_mental_illness_nhsd", 
              "sickle_cell_disease_nhsd", "vaccination_status")

# Model data
data_model <- data_processed_clean %>% 
  select(patient_id, treated_observed, all_of(variables), week) %>%
  filter(complete.cases(.)) 

# Table 1 template
table_demo_clinc_breakdown <- data_model %>%
  filter(!is.na(treated_observed)) %>%
  select(treated_observed, all_of(variables)) %>%
  tbl_summary(by = treated_observed) %>%
  add_overall()

table_demo_clinc_breakdown$inputs$data <- NULL

table1 <- table_demo_clinc_breakdown$table_body %>%
  separate(stat_0, c("stat_0","perc0"), sep = " ([(])") %>%
  separate(stat_1, c("stat_1","perc1"), sep = " ([(])") %>%
  separate(stat_2, c("stat_2","perc2"), sep = " ([(])") %>%
  select(Group = variable,
         Variable = label, 
         All = stat_0,
         Untreated = stat_1,
         Treated = stat_2) %>%
  mutate(Treated = as.numeric(gsub(",", "", Treated)),
         Untreated = as.numeric(gsub(",", "", Untreated)),
         All = as.numeric(gsub(",", "", All))) %>%
  data.frame() %>%
  filter(!(Variable %in% c("Unknown", "0")),
         !is.na(All),
         Group != "stp") %>%
  mutate(term = paste(Group, Variable, sep = ""),
         term = ifelse(term == "high_risk_group_combined_counthigh_risk_group_combined_count", "high_risk_group_combined_count", term))


## Logistic model - unadjusted

table.mod.unadj <- list()

for (i in 1:length(variables)){
  formula    <- as.formula(paste("treated_observed ~", variables[i]))
  res.logist <- glm(formula, data = data_model, family = binomial(link = 'logit'),)
  
  mod.unadj <- tidy_wald(res.logist, exponentiate = TRUE)
  table.mod.unadj <-rbind(table.mod.unadj, mod.unadj[-1,])
  
}

mod.unadj <- glm(treated_observed ~ 1, data = data_model, family = binomial(link = 'logit'))


## Logistic model - adjusted
mod.adj <- gam(treated_observed ~ ageband + sex + ethnicity + imd + rural_urban + region_nhs + stp + 
               downs_syndrome + solid_cancer + haematological_disease + renal_disease + liver_disease + imid +immunosupression +
               hiv_aids + solid_organ_transplant + rare_neurological_conditions + autism_nhsd +
               care_home_primis + dementia_nhsd + housebound_opensafely + learning_disability_primis + shielded_primis +
               serious_mental_illness_nhsd + sickle_cell_disease_nhsd + vaccination_status + s(week),
             family = binomial(link = 'logit'),
             data = data_model)

table.mod.adj <- broom::tidy(mod.adj, parametric = TRUE, exponentiate = TRUE, conf.int = TRUE) %>%
  as.data.frame()

## Logistic model - adjusted (without ethnicity)
mod.adj.1 <- gam(treated_observed ~ ageband + sex + imd + rural_urban + region_nhs + stp + 
               downs_syndrome + solid_cancer + haematological_disease + renal_disease + liver_disease + imid +immunosupression +
               hiv_aids + solid_organ_transplant + rare_neurological_conditions + autism_nhsd +
               care_home_primis + dementia_nhsd + housebound_opensafely + learning_disability_primis + shielded_primis +
               serious_mental_illness_nhsd + sickle_cell_disease_nhsd + vaccination_status + s(week),
             family = binomial(link = 'logit'),
             data = data_model)

table.mod.adj.1 <- broom::tidy(mod.adj, parametric = TRUE, exponentiate = TRUE, conf.int = TRUE) %>%
  as.data.frame()

## Logistic model - adjusted (without high risk group)
mod.adj.2 <- gam(treated_observed ~ ageband + sex + ethnicity + imd + rural_urban + region_nhs + stp + autism_nhsd +
               care_home_primis + dementia_nhsd + housebound_opensafely + learning_disability_primis + shielded_primis +
               serious_mental_illness_nhsd + sickle_cell_disease_nhsd + vaccination_status + s(week),
             family = binomial(link = 'logit'),
             data = data_model)

table.mod.adj.2 <- broom::tidy(mod.adj, parametric = TRUE, exponentiate = TRUE, conf.int = TRUE) %>%
  as.data.frame()

## Logistic model - adjusted (without region
mod.adj.3 <- gam(treated_observed ~ ageband + sex + ethnicity + imd + rural_urban + stp + autism_nhsd +
               care_home_primis + dementia_nhsd + housebound_opensafely + learning_disability_primis + shielded_primis +
               serious_mental_illness_nhsd + sickle_cell_disease_nhsd + vaccination_status + s(week),
             family = binomial(link = 'logit'),
             data = data_model)

table.mod.adj.3 <- broom::tidy(mod.adj, parametric = TRUE, exponentiate = TRUE, conf.int = TRUE) %>%
  as.data.frame()


# Results
results.table <- data.frame(cutoff = c(seq(0.1:1, by = 0.1)),
                            Accuracy = NA,
                            Sensitivity = NA,
                            Specificity = NA,
                            AUC = NA,
                            misClasificError = NA,
                            Brierscore = NA,
                            OE = NA)

cutoffs <- seq(0.1:1, by = 0.1)

for (i in 1:length(cutoffs)){
  
  results <- data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results > cutoffs[i], 1, 0))
  
  results.table[i,2] <- round(results %>% filter(treated_expected == treated_observed) %>% nrow()/results %>% nrow(), digits = 2)
  results.table[i,3] <- round(results %>% filter(treated_observed == 1, 
                                              treated_expected == treated_observed) %>% nrow()/
                             results %>% filter(treated_observed == 1) %>% nrow(), digits = 2)
  results.table[i,4] <- round(results %>% filter(treated_observed == 0, 
                                              treated_expected == treated_observed) %>% nrow()/
                             results %>% filter(treated_observed == 0) %>% nrow(), digits = 2)
  results.table[i,5] <- round(as.numeric(auc(results$treated_observed, results$treated_expected)), digits = 2)
  results.table[i,6] <- round(1 - mean(results$treated_expected == results$treated_observed, na.rm = T), digits = 2)
  results.table[i,7] <- mean((results$fitted.results - results$treated_observed)^2, na.rm = T)
  results.table[i,8] <- sum(results$treated_observed, na.rm = T)/sum(results$treated_expected, na.rm = T)

}

results <- data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0))

accuracy <- round(results %>% filter(treated_expected == treated_observed) %>% nrow()/results %>% nrow(), digits = 2)
sensitivity <- round(results %>% filter(treated_observed == 1, treated_expected == treated_observed) %>% nrow()/
                             results %>% filter(treated_observed == 1) %>% nrow(), digits = 2)
specificity <- round(results %>% filter(treated_observed == 0, treated_expected == treated_observed) %>% nrow()/
                             results %>% filter(treated_observed == 0) %>% nrow(), digits = 2)
auc <- round(as.numeric(auc(results$treated_observed, results$treated_expected)), digits = 2)
misClasificError <- round(1 - mean(results$treated_expected == results$treated_observed, na.rm = T), digits = 2)
brierscore <- mean((results$fitted.results - results$treated_observed)^2, na.rm = T)

overall <- results %>% 
  select(treated_observed, treated_expected) %>%
  summarise(treated_observed = sum(treated_observed, na.rm = T),
            treated_expected = sum(treated_expected, na.rm = T)) %>%
  mutate(y = sum(treated_observed, na.rm = T)/sum(treated_expected, na.rm = T),
         ymin = y - 1.96*sqrt(treated_observed)/treated_expected,
         ymax = y + 1.96*sqrt(treated_observed)/treated_expected)

overall_unadjusted <- data_processed_clean %>%
    mutate(fitted.results = predict(mod.unadj, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
  select(treated_observed, treated_expected) %>%
  summarise(treated_observed = sum(treated_observed, na.rm = T),
            treated_expected = sum(treated_expected, na.rm = T)) %>%
  mutate(y = sum(treated_observed, na.rm = T)/sum(treated_expected, na.rm = T),
         ymin = y - 1.96*sqrt(treated_observed)/treated_expected,
         ymax = y + 1.96*sqrt(treated_observed)/treated_expected)

```

<br>

# Background
As is well known, in most observational studies treatment selection/assignment is not random and is often influenced by subject characteristics (i.e., measured and unmeasured characteristics of individuals are associated with likelihood of receiving treatment and with the outcome). Eligible patients who receive a nMAB or antiviral as treatment for COVID-19 are therefore likely to be very different to eligible patients who do not receive treatment and baseline characteristics of treated patients will likely differ systematically from those of untreated subjects. For example, patients who are offered treatment will be those who are less likely to be severely ill with COVID-19.

Preliminary results have shown that there is some variation in which eligible patients are receiving treatment. Variation is appearing across high risk groups and regions, but it is possible that other factors such as ethnicity are driving these inequalities. Currently numbers are too small to look at results broken down by more than one category (i.e a breakdown of ethnicity by high risk group by region would have too few numbers in each group) so there is a need for another method to try to ascertain whether any real variation exists and if so, where it is occurring.

The aim of this bit of work is to attempt to describe any variation in eligible patients receiving an nMAB or antiviral as treatment for COVID-19 by developing a model to predict treatment status and comparing observed to expected values.

# Method
Logistic regression was used to model and predict each patients treatment status (either did not receive a nMAB or antiviral as treatment for COVID-19 or received a nMAB or antiviral as treatment for COVID-19), firstly unadjusted, then by adjusting for all covariates simultaneously to identify independent associations between covariates and the outcome. To explore the variations seen in patients receiving treatment across different ethnicities, high risk groups and regions, separate multivariate logistic models were fitted for each of the groups with the variable of interest (ethnicity, high risk group or region) omitted from the model.

The following demographic and clinical covariates were considered for inclusion in models:

* Age
* Sex
* Ethnicity
* Index of Multiple Deprivation
* Urban/rural classification
* Region
* STP
* High risk group
* High-risk groups/conditions; autism, care home, dementia, housebound, learning disability, shielded, serious mental illness
* Vaccination status
* Week of treatment

Unadjusted and adjusted ORs were calculated, and the distribution of the probabilities/propensity scores for patients who did/did not recieved received treatment for COVID-19 were plotted. In addition, ratios of observed to expected number of patients receiving treatment were calculated. To do this, the expected number of patients receiving treatment for each group was calculated by predicting the treatment status for every patient using the relevant adjusted model, and then summing over all patients within each group. In this way, it was possible to obtain the expected value E, which could then be compared to the observed value O, highlighting the groups with treatment rates that differed from the expected rate for the eligible population. Both caterpillar plots and funnel plots were constructed to compare the ratio of the observed to expected number of patients receiving treatment. 


# Results

## Logistic regression
As shown in Table 1, several variables were associated with treatment status. After adjustment for all demographic and clinical variables, `r round((1-summary(mod.adj)$dev.expl)*100, digits = 0)`% of the variation remained unexplained. The distributions of the propensity scores are shown in Figure 1, showing a large overlap between the scores for patients who did/did not recieved received treatment for COVID-19, indicating a minor difference in the associated covariates between the two groups.

**Table 1 Count and proportion of the total number of eligible patients in OpenSAFELY-TPP since 16th December 2021, stratified by treatment status, along with odds ratios from a univariable and multivariable logistic regression model** Patient counts <8 have been redacted and counts >7 are rounded to the nearest 10; as a result percentages may not add up to 100%."

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', out.width = '100%'}

table1.full <- full_join(table1, table.mod.unadj, by = "term") %>%
  full_join(table.mod.adj, by = "term") %>%
  mutate(estimate.x = round(estimate.x, digits = 2),
         conf.x = paste("(", round(conf.low.x, digits = 2), " - ", round(conf.high.x, digits = 2), ")", sep = ""),
         p.value.x = round(p.value.x, digits = 4),
         estimate.y = round(exp(estimate.y), digits = 2),
         conf.y = paste("(", round(exp(conf.low.y), digits = 2), " - ", round(exp(conf.high.y), digits = 2), ")", sep = ""),
         p.value.y = round(p.value.y, digits = 4)) %>%
  select(Group, Variable, All, Untreated, Treated,
         Unadjusted_OR = estimate.x, Unadjusted_95CI = conf.x, Unadjusted_p = p.value.x,
         Adjusted_OR = estimate.y, Adjusted_95CI = conf.y, Adjusted_p = p.value.y) %>%
  filter(!is.na(Group)) %>%
  mutate(Variable = ifelse(Variable == 1, Group, Variable)) %>%
  mutate(Group = factor(Group, 
                        levels = c("ageband", "sex", "ethnicity", "imd", "rural_urban", "region_nhs",
                                   "downs_syndrome", "solid_cancer", "haematological_disease", "renal_disease", "liver_disease",
                                   "imid", "immunosupression", "hiv_aids", "solid_organ_transplant", "rare_neurological_conditions",
                                   "autism_nhsd", "care_home_primis", "dementia_nhsd",  "housebound_opensafely", "learning_disability_primis",
                                   "shielded_primis", "serious_mental_illness_nhsd", "sickle_cell_disease_nhsd", "vaccination_status"),
                        labels = c("Age band", "Sex", "Ethnicity", "IMD", "Rurality", "Region", rep("High risk group", 10),
                                   rep("Clinical group", 8),
                                   "Vaccination status")),
         Variable = factor(Variable, 
                           levels = c("12-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+", 
                                      "Female", "Male" ,
                                      "White", "Asian or Asian British", "Black or Black British", "Mixed", "Other ethnic groups",
                                      "1 most deprived", "2", "3", "4", "5 least deprived",
                                      "Urban - conurbation" , "Urban - city and town", "Rural - town and fringe", 
                                      "Rural - village and dispersed",
                                      "East Midlands", "East of England", "London", "North East", "North West", "South East",
                                      "South West", "West Midlands", "Yorkshire and the Humber",
                                      "downs_syndrome", "solid_cancer", "haematological_disease", "renal_disease", "liver_disease",
                                      "imid", "immunosupression", "hiv_aids", "solid_organ_transplant", "rare_neurological_conditions",
                                      "autism_nhsd", "care_home_primis", "dementia_nhsd", "housebound_opensafely", "learning_disability_primis",
                                      "shielded_primis", "serious_mental_illness_nhsd", "sickle_cell_disease_nhsd", 
                                      "Un-vaccinated (declined)", "Un-vaccinated" , "One vaccination", "Two vaccinations", 
                                      "Three or more vaccinations", "Unknown"),
                           labels = c("12-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+", 
                                      "Female", "Male" ,
                                      "White", "Asian or Asian British", "Black or Black British", "Mixed", "Other ethnic groups",
                                      "1 most deprived", "2", "3", "4", "5 least deprived",
                                      "Urban - conurbation" , "Urban - city and town", "Rural - town and fringe", 
                                      "Rural - village and dispersed",
                                      "East Midlands", "East of England", "London", "North East", "North West", "South East",
                                      "South West", "West Midlands", "Yorkshire and the Humber",
                                      "Downs syndrome", "Solid cancer", "Haematological disease", "Renal disease", "Liver disease",
                                      "IMID", "Immunosupression", "Hiv/aids", "Solid Organ transplant", "Rare neurological conditions",
                                      "Autism", "Care home", "Dementia", "Housebound", "Learning disability ", "CEV", "Serious mental illness",
                                      "Sickle cell disease",
                                      "Un-vaccinated (declined)", "Un-vaccinated" , "One vaccination", "Two vaccinations", 
                                      "Three or more vaccinations", "Unknown")))  %>%
  mutate(
    # Redact values < 8
    All = ifelse(All < threshold, NA, as.numeric(All)),
    Treated = ifelse(Treated < threshold, NA, as.numeric(Treated)),
    Untreated = ifelse(Untreated < threshold, NA, as.numeric(Untreated)),
    # Round to nearest 10
    All = plyr::round_any(All, 10),
    Treated = plyr::round_any(Treated, 10),
    Untreated = plyr::round_any(as.numeric(Untreated), 10)) %>%
  mutate(Untreated = paste(Untreated, " (", round(Untreated/All*100, digits = 0), ")", sep = ""),
         Treated = paste(Treated, " (", round(Treated/All*100, digits = 0), ")", sep = "")) %>%  
  mutate(All = ifelse(is.na(All), "<8", All),
         Treated = ifelse(Treated == "NA (NA)", "--", Treated),
         Untreated = ifelse(Untreated == "NA (NA)", "--", Untreated),
         Unadjusted_OR = ifelse(is.na(Unadjusted_OR), "(REF)", Unadjusted_OR),
         Unadjusted_95CI = ifelse(Unadjusted_OR == "(REF)" | All  == "<8", "--", Unadjusted_95CI),
         Unadjusted_p = ifelse(Unadjusted_OR == "(REF)" | All  == "<8", "--", Unadjusted_p),
         Adjusted_OR = ifelse(is.na(Adjusted_OR), "(REF)", Adjusted_OR),
         Adjusted_95CI = ifelse(Adjusted_OR == "(REF)" | All  == "<8", "--", Adjusted_95CI),
         Adjusted_p = ifelse(Adjusted_OR == "(REF)" | All  == "<8", "--", Adjusted_p))

colnames(table1.full) <- c("", "", "n", "n (%)", "n (%)", "Odds Ratio", "95% CI", "P-value", "Odds Ratio", "95% CI", "P-value")

table1.full %>%
  kable(row.names = FALSE, 
        align = c("l", rep("c", 13)),
        booktabs=TRUE) %>%
  kable_styling(position = "center", full_width = T, bootstrap_options = "striped", font_size = 10) %>%
  column_spec(1, bold = T, width = "10em") %>%
  column_spec(2, width = "5em") %>%
  add_header_above(., c("Variable ", "Level", "All", "Untreated", "Treated", "Univariable" = 3,
                        "Multivariable" = 3)) %>%
  add_header_above(., c(" ", " ", "Treatment status" = 3, "Logistic regression" = 6)) 
```

<br>

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', out.width = '50%', fig.show = "hold", fig.cap = "**Figure 1. Distribution of propensity scores (calculated using multivariate logistic model) in patients who did/did not recieved received treatment for COVID-19**" , fig.topcaption=TRUE}

# 1. Create the histogram plot
phist <- data_processed_clean %>%
  mutate(fitted.results = predict(mod.adj, newdata = data_processed_clean, type = 'response'),
         treatment_status = ifelse(treated_observed == 1, "Untreated", "Treated")) %>%
  gghistogram(
    x = "fitted.results", y = "..density..",
    fill = "treatment_status", palette = c("#00AFBB", "#E7B800"),
    add_density = FALSE) +
  xlab("Propensity score") + 
  ylab("Number of patients") + 
  theme_bw() +
  theme(legend.position = "right",
        legend.title = element_blank())

# 2. Create the density plot with y-axis on the right
pdensity <- data_processed_clean %>%
  mutate(fitted.results = predict(mod.adj, newdata = data_processed_clean, type = 'response'),
         treatment_status = ifelse(treated_observed == 1, "Untreated", "Treated")) %>%
  ggdensity(
    x = "fitted.results", 
  color= "treatment_status", palette = c("#00AFBB", "#E7B800"),
  alpha = 0) +  
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), position = "right")  +
  theme_half_open(11, rel_small = 1) +
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

# 3. Align the two plots and then overlay them.
aligned_plots <- align_plots(phist, pdensity, align="hv", axis="tblr")
ggdraw(aligned_plots[[1]]) + draw_plot(aligned_plots[[2]])

# Box plot 
data_processed_clean %>%
  mutate(fitted.results = predict(mod.adj, newdata = data_processed_clean, type = 'response'),
         treatment_status = ifelse(treated_observed == 1, "Treated", "Untreated")) %>%
  ggplot(aes(x=treatment_status, y=fitted.results, colour = treatment_status)) + 
  geom_boxplot()  +
  xlab("Treatment status") + 
  ylab("Propensity score") + 
  theme_bw()  +
  rremove("legend") +
  scale_colour_manual(values = c("#00AFBB", "#E7B800"))
```



## Observed to expected ratios

### Ethnicity

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', out.width = '100%', fig.cap = "**Figure 2a. Observed to expected (adjusted) ratio of the number of patients receiving treatment, stratified by ethnicity.** The squares represent the point estimates, and the areas of the squares are proportional to the observed number of patients receiving treatment. The vertical lines display 95% confidence intervals. The solid and dashed horizontal blue lines represent the overall observed to expected ratio of the number of patients receiving treatment with a 95% CI, respectively.", fig.topcaption=TRUE}
  
# Caterpillar plot
ethnicity_overall <- data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj.1, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0))  %>% 
  select(ethnicity, treated_observed, treated_expected) %>%
  summarise(treated_observed = sum(treated_observed, na.rm = T),
            treated_expected = sum(treated_expected, na.rm = T)) %>%
  mutate(y = sum(treated_observed, na.rm = T)/sum(treated_expected, na.rm = T),
         ymin = y - 1.96*sqrt(treated_observed)/treated_expected,
         ymax = y + 1.96*sqrt(treated_observed)/treated_expected)

data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj.1, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0))  %>% 
  select(ethnicity, treated_observed, treated_expected) %>%
  group_by(ethnicity) %>%
  summarise(treated_observed = sum(treated_observed, na.rm = T),
            treated_expected = sum(treated_expected, na.rm = T)) %>%
  mutate(obs_exp_ratio = treated_observed/treated_expected,
         lower_ci = obs_exp_ratio - 1.96*sqrt(treated_observed)/treated_expected,
         upper_ci = obs_exp_ratio + 1.96*sqrt(treated_observed)/treated_expected) %>%
  filter(!is.na(ethnicity)) %>%
  ggplot(aes(x = ethnicity, y = obs_exp_ratio)) + 
  geom_point(aes(size = treated_observed), shape = "square") +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width=.1) +
  theme_classic(base_size = 8) +
  labs(
    x = "Ethnicity",
    y = "Observed to expected ratio of treated patients",
    size = "Observed number of treated patients",
    title = "(a)") +
  #geom_hline(yintercept = 1, linetype = "dashed")  +
  geom_hline(yintercept = ethnicity_overall$y, colour = "steelblue2") +
  geom_hline(yintercept = ethnicity_overall$ymin, linetype = "dashed", colour = "steelblue2") +
  geom_hline(yintercept = ethnicity_overall$ymax, linetype = "dashed", colour = "steelblue2") +
  theme(
    legend.position = "bottom",
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 10),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank())

```

<br>

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', out.width = '100%', fig.cap = "**Figure 2b.  Adjusted funnel plots showing the ratio of the observed to expected number of patients receiving treatment,  stratified by ethnicity.** Coloured points represent adjusted ratios. Solid black lines are 95% intervals and black dotted lines are 99.9% intervals, derived using the Poisson distribution. The solid horizontal blue line represent the overall observed to expected ratio of the number of patients receiving treatment", fig.topcaption=TRUE}

# Funnel plot
funnel_plot <- rbind(data_processed_clean %>%
                       mutate(fitted.results = predict(mod.unadj, newdata = data_processed_clean, type = 'response'),
                              treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
                     select(ethnicity, treated_observed, treated_expected) %>%
                     group_by(ethnicity) %>%
                     summarise(treated_observed = sum(treated_observed, na.rm = T),
                               treated_expected = sum(treated_expected, na.rm = T)) %>%
                     mutate(obs_exp_ratio = treated_observed/treated_expected,
                            lower_ci = obs_exp_ratio - 1.96*sqrt(treated_observed)/treated_expected,
                            upper_ci = obs_exp_ratio + 1.96*sqrt(treated_observed)/treated_expected,
                            mod = "unadjusted") %>%
                     filter(!is.na(ethnicity)),
                     data_processed_clean %>%
                       mutate(fitted.results = predict(mod.adj.1, newdata = data_processed_clean, type = 'response'),
                              treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
                     select(ethnicity, treated_observed, treated_expected) %>%
                     group_by(ethnicity) %>%
                     summarise(treated_observed = sum(treated_observed, na.rm = T),
                               treated_expected = sum(treated_expected, na.rm = T)) %>%
                     mutate(obs_exp_ratio = treated_observed/treated_expected,
                            lower_ci = obs_exp_ratio - 1.96*sqrt(treated_observed)/treated_expected,
                            upper_ci = obs_exp_ratio + 1.96*sqrt(treated_observed)/treated_expected,
                            mod = "adjusted") %>%
                     filter(!is.na(ethnicity)))

dfCI <- data.frame(number.seq = seq(plyr::round_any(min(subset(funnel_plot, mod =="adjusted")$treated_expected, na.rm = T), 100, floor), 
                                    plyr::round_any(max(subset(funnel_plot, mod =="adjusted")$treated_expected, na.rm = T), 100, ceiling), 
                                    1)) %>%
  mutate(number.ll95 = overall$y - 1.96 * sqrt(overall$y/number.seq),
         number.ul95 = overall$y + 1.96 * sqrt(overall$y/number.seq),
         number.ll999 = overall$y - 3.29 * sqrt(overall$y/number.seq),
         number.ul999 = overall$y + 3.29 * sqrt(overall$y/number.seq))

funnel_plot %>%
  filter(mod == "adjusted") %>%
  ggplot(aes(x = treated_expected, y = obs_exp_ratio)) + 
  geom_point(aes(colour = ethnicity), size = 2) +
  geom_line(aes(x = number.seq, y = number.ll95), data = dfCI) +
  geom_line(aes(x = number.seq, y = number.ul95), data = dfCI) +
  geom_line(aes(x = number.seq, y = number.ll999), linetype = "dashed", data = dfCI) +
  geom_line(aes(x = number.seq, y = number.ul999), linetype = "dashed", data = dfCI) +
  #xlim(min(dfCI$number.seq), max(dfCI$number.seq)) +
  #ylim(min(dfCI$number.ll999), max(dfCI$number.ul999)) +
  xlab("Expected number of treated patients") + 
  ylab("Observed to expected ratio of treated patients") + 
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  #guides(shape = "none") +
  geom_segment(aes(min(dfCI$number.seq), xend =  max(dfCI$number.seq), 
                   y = ethnicity_overall$y, yend = ethnicity_overall$y),
               colour = "steelblue2")

```


### High risk groups

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', out.width = '100%', fig.cap = "**Figure 3a. Observed to expected (adjusted) ratio of the number of patients receiving treatment, stratified by high risk group.** The squares represent the point estimates, and the areas of the squares are proportional to the observed number of patients receiving treatment. The vertical lines display 95% confidence intervals. The solid and dashed horizontal blue lines represent the overall observed to expected ratio of the number of patients receiving treatment with a 95% CI, respectively.", fig.topcaption=TRUE}

# Caterpillar plot
hrc_overall <- data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj.2, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0))  %>% 
  select(treated_observed, treated_expected) %>%
  summarise(treated_observed = sum(treated_observed, na.rm = T),
            treated_expected = sum(treated_expected, na.rm = T)) %>%
  mutate(y = sum(treated_observed, na.rm = T)/sum(treated_expected, na.rm = T),
         ymin = y - 1.96*sqrt(treated_observed)/treated_expected,
         ymax = y + 1.96*sqrt(treated_observed)/treated_expected)

# High risk group
data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj.2, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
  select(treated_observed, downs_syndrome, solid_cancer, haematological_disease, renal_disease, liver_disease, imid, immunosupression, 
         hiv_aids, solid_organ_transplant, rare_neurological_conditions)  %>%
  mutate(across(
    .cols = c(where(is.factor)),
    .fns = ~as.numeric(as.character(.x))
  )) %>%
  group_by(treated_observed) %>%
  summarise(
    across(.fns=sum, na.rm = T)
  ) %>%
  filter(treated_observed == 1) %>%
  select(-treated_observed) %>%
  pivot_longer(
    cols = c(downs_syndrome, solid_cancer, haematological_disease, renal_disease, liver_disease, imid, immunosupression, 
             hiv_aids, solid_organ_transplant, rare_neurological_conditions),
    names_to = "high_risk_cohort",
    values_to = "treated_observed"
  ) %>%
  full_join(data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj.2, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
              select(treated_expected, downs_syndrome, solid_cancer, haematological_disease, renal_disease, liver_disease, imid,
                     immunosupression, hiv_aids, solid_organ_transplant, rare_neurological_conditions)  %>%
              mutate(across(
                .cols = c(where(is.factor)),
                .fns = ~as.numeric(as.character(.x))
              )) %>%
              group_by(treated_expected) %>%
              summarise(
                across(.fns=sum, na.rm = T)
              ) %>%
              filter(treated_expected == 1) %>%
              select(-treated_expected) %>%
              pivot_longer(
                cols = c(downs_syndrome, solid_cancer, haematological_disease, renal_disease, liver_disease, imid, immunosupression, 
                         hiv_aids, solid_organ_transplant, rare_neurological_conditions),
                names_to = "high_risk_cohort",
                values_to = "treated_expected"
              ), by = "high_risk_cohort") %>%
  mutate(obs_exp_ratio = treated_observed/treated_expected,
         lower_ci = obs_exp_ratio - 1.96*sqrt(treated_observed)/treated_expected,
         upper_ci = obs_exp_ratio + 1.96*sqrt(treated_observed)/treated_expected) %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immunosuppression due to HIV or AIDS", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_)) %>%
  mutate(high_risk_cohort = unlist(lapply(strwrap(high_risk_cohort, width=20, simplify=FALSE), paste, collapse="\n"))) %>%
  ggplot(aes(x = high_risk_cohort, y = obs_exp_ratio)) + 
  geom_point(aes(size = treated_observed), shape = "square") +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width=.1) +
  theme_classic(base_size = 8) +
  labs(
    x = "High risk group",
    y = "Observed to expected ratio of treated patients",
    size = "Observed number of treated patients",
    title = "(b)") +
  #geom_hline(yintercept = 1, linetype = "dashed") +
  geom_hline(yintercept = hrc_overall$y, colour = "steelblue2") +
  geom_hline(yintercept = hrc_overall$ymin, linetype = "dashed", colour = "steelblue2") +
  geom_hline(yintercept = hrc_overall$ymax, linetype = "dashed", colour = "steelblue2") +
  theme(
    legend.position = "bottom",
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 10),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank())

```

<br>

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', out.width = '100%', fig.cap = "**Figure 3b.  Adjusted funnel plots showing the ratio of the observed to expected number of patients receiving treatment,  stratified by high risk group** Coloured points represent adjusted ratios. Solid black lines are 95% intervals and black dotted lines are 99.9% intervals, derived using the Poisson distribution. The solid horizontal blue line represent the overall observed to expected ratio of the number of patients receiving treatment", fig.topcaption=TRUE}

# Funnel plot
funnel_plot <- data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj.2, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
  select(treated_observed, downs_syndrome, solid_cancer, haematological_disease, renal_disease, liver_disease, imid, immunosupression, 
         hiv_aids, solid_organ_transplant, rare_neurological_conditions)  %>%
  mutate(across(
    .cols = c(where(is.factor)),
    .fns = ~as.numeric(as.character(.x))
  )) %>%
  group_by(treated_observed) %>%
  summarise(
    across(.fns=sum, na.rm = T)
  ) %>%
  filter(treated_observed == 1) %>%
  select(-treated_observed) %>%
  pivot_longer(
    cols = c(downs_syndrome, solid_cancer, haematological_disease, renal_disease, liver_disease, imid, immunosupression, 
             hiv_aids, solid_organ_transplant, rare_neurological_conditions),
    names_to = "high_risk_cohort",
    values_to = "treated_observed"
  ) %>%
  full_join(data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj.2, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
              select(treated_expected, downs_syndrome, solid_cancer, haematological_disease, renal_disease, liver_disease, imid,
                     immunosupression, hiv_aids, solid_organ_transplant, rare_neurological_conditions)  %>%
              mutate(across(
                .cols = c(where(is.factor)),
                .fns = ~as.numeric(as.character(.x))
              )) %>%
              group_by(treated_expected) %>%
              summarise(
                across(.fns=sum, na.rm = T)
              ) %>%
              filter(treated_expected == 1) %>%
              select(-treated_expected) %>%
              pivot_longer(
                cols = c(downs_syndrome, solid_cancer, haematological_disease, renal_disease, liver_disease, imid, immunosupression, 
                         hiv_aids, solid_organ_transplant, rare_neurological_conditions),
                names_to = "high_risk_cohort",
                values_to = "treated_expected"
              ), by = "high_risk_cohort") %>%
  mutate(obs_exp_ratio = treated_observed/treated_expected,
         lower_ci = obs_exp_ratio - 1.96*sqrt(treated_observed)/treated_expected,
         upper_ci = obs_exp_ratio + 1.96*sqrt(treated_observed)/treated_expected) %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immunosuppression due to HIV or AIDS", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_)) %>%
  mutate(high_risk_cohort = unlist(lapply(strwrap(high_risk_cohort, width=20, simplify=FALSE), paste, collapse="\n")))

dfCI <- data.frame(number.seq = seq(plyr::round_any(min(funnel_plot$treated_expected, funnel_plot$treated_expected, na.rm = T), 100, floor), 
                                    plyr::round_any(max(funnel_plot$treated_expected, funnel_plot$treated_expected, na.rm = T), 100, ceiling), 
                                    1)) %>%
  mutate(number.ll95 = hrc_overall$y - 1.96 * sqrt(hrc_overall$y/number.seq),
         number.ul95 = hrc_overall$y + 1.96 * sqrt(hrc_overall$y/number.seq),
         number.ll999 = hrc_overall$y - 3.29 * sqrt(hrc_overall$y/number.seq),
         number.ul999 = hrc_overall$y + 3.29 * sqrt(hrc_overall$y/number.seq))

funnel_plot %>%
  ggplot(aes(x = treated_expected, y = obs_exp_ratio)) + 
  geom_point(aes(colour = high_risk_cohort), size = 2) +
  geom_line(aes(x = number.seq, y = number.ll95), data = dfCI) +
  geom_line(aes(x = number.seq, y = number.ul95), data = dfCI) +
  geom_line(aes(x = number.seq, y = number.ll999), linetype = "dashed", data = dfCI) +
  geom_line(aes(x = number.seq, y = number.ul999), linetype = "dashed", data = dfCI) +
  #xlim(min(dfCI$number.seq), max(dfCI$number.seq)) +
  #ylim(min(dfCI$number.ll999), max(dfCI$number.ul999)) +
  xlab("Expected number of treated patients") + 
  ylab("Observed to expected ratio of treated patients") + 
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  #guides(shape = "none") +
  geom_segment(aes(min(dfCI$number.seq), xend =  max(dfCI$number.seq), 
                   y = hrc_overall$y, yend = hrc_overall$y),
               colour = "steelblue2")

```


### Region

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', out.width = '100%', fig.cap = "**Figure 4a. Observed to expected (adjusted) ratio of the number of patients receiving treatment, stratified by region** The squares represent the point estimates, and the areas of the squares are proportional to the observed number of patients receiving treatment. The vertical lines display 95% confidence intervals. The solid and dashed horizontal blue lines represent the overall observed to expected ratio of the number of patients receiving treatment with a 95% CI, respectively.", fig.topcaption=TRUE}
  
# Caterpillar plot
region_overall <- data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj.3, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0))  %>% 
  select(region_nhs, treated_observed, treated_expected) %>%
  summarise(treated_observed = sum(treated_observed, na.rm = T),
            treated_expected = sum(treated_expected, na.rm = T)) %>%
  mutate(y = sum(treated_observed, na.rm = T)/sum(treated_expected, na.rm = T),
         ymin = y - 1.96*sqrt(treated_observed)/treated_expected,
         ymax = y + 1.96*sqrt(treated_observed)/treated_expected)

data_processed_clean %>%
    mutate(fitted.results = predict(mod.adj.3, newdata = data_processed_clean, type = 'response'),
         treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
  select(region_nhs, treated_observed, treated_expected) %>%
  group_by(region_nhs) %>%
  summarise(treated_observed = sum(treated_observed, na.rm = T),
            treated_expected = sum(treated_expected, na.rm = T)) %>%
  mutate(obs_exp_ratio = treated_observed/treated_expected,
         lower_ci = obs_exp_ratio - 1.96*sqrt(treated_observed)/treated_expected,
         upper_ci = obs_exp_ratio + 1.96*sqrt(treated_observed)/treated_expected) %>%
  ggplot(aes(x = region_nhs, y = obs_exp_ratio)) + 
  geom_point(aes(size = treated_observed), shape = "square") +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width=.1) +
  theme_classic(base_size = 8) +
  labs(
    x = "Region",
    y = "Observed to expected ratio of treated patients",
    size = "Observed number of treated patients",
    title = "(c)") +
  #geom_hline(yintercept = 1, linetype = "dashed") +
  geom_hline(yintercept = region_overall$y, colour = "steelblue2") +
  geom_hline(yintercept = region_overall$ymin, linetype = "dashed", colour = "steelblue2") +
  geom_hline(yintercept = region_overall$ymax, linetype = "dashed", colour = "steelblue2") +
  theme(
    legend.position = "bottom",
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 10),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank())

```

<br>

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', out.width = '100%', fig.cap = "**Figure 4b.  Adjusted funnel plots showing the ratio of the observed to expected number of patients receiving treatment, stratified by region** Coloured points represent adjusted ratios. Solid black lines are 95% intervals and black dotted lines are 99.9% intervals, derived using the Poisson distribution. The solid horizontal blue line represent the overall observed to expected ratio of the number of patients receiving treatment", fig.topcaption=TRUE}

# Funnel plot
funnel_plot <- rbind(data_processed_clean %>%
                       mutate(fitted.results = predict(mod.unadj, newdata = data_processed_clean, type = 'response'),
                              treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
                     select(ethnicity, treated_observed, treated_expected) %>%
                     group_by(ethnicity) %>%
                     summarise(treated_observed = sum(treated_observed, na.rm = T),
                               treated_expected = sum(treated_expected, na.rm = T)) %>%
                     mutate(obs_exp_ratio = treated_observed/treated_expected,
                            lower_ci = obs_exp_ratio - 1.96*sqrt(treated_observed)/treated_expected,
                            upper_ci = obs_exp_ratio + 1.96*sqrt(treated_observed)/treated_expected,
                            mod = "unadjusted") %>%
                     filter(!is.na(ethnicity)),
                     data_processed_clean %>%
                       mutate(fitted.results = predict(mod.adj.3, newdata = data_processed_clean, type = 'response'),
                              treated_expected = ifelse(fitted.results >= 0.5, 1, 0)) %>% 
                     select(ethnicity, treated_observed, treated_expected) %>%
                     group_by(ethnicity) %>%
                     summarise(treated_observed = sum(treated_observed, na.rm = T),
                               treated_expected = sum(treated_expected, na.rm = T)) %>%
                     mutate(obs_exp_ratio = treated_observed/treated_expected,
                            lower_ci = obs_exp_ratio - 1.96*sqrt(treated_observed)/treated_expected,
                            upper_ci = obs_exp_ratio + 1.96*sqrt(treated_observed)/treated_expected,
                            mod = "adjusted") %>%
                     filter(!is.na(ethnicity)))

dfCI <- data.frame(number.seq = seq(plyr::round_any(min(subset(funnel_plot, mod =="adjusted")$treated_expected, na.rm = T), 100, floor), 
                                    plyr::round_any(max(subset(funnel_plot, mod =="adjusted")$treated_expected, na.rm = T), 100, ceiling), 
                                    1)) %>%
  mutate(number.ll95 = overall$y - 1.96 * sqrt(overall$y/number.seq),
         number.ul95 = overall$y + 1.96 * sqrt(overall$y/number.seq),
         number.ll999 = overall$y - 3.29 * sqrt(overall$y/number.seq),
         number.ul999 = overall$y + 3.29 * sqrt(overall$y/number.seq))

funnel_plot %>%
  filter(mod == "adjusted") %>%
  ggplot(aes(x = treated_expected, y = obs_exp_ratio)) + 
  geom_point(aes(colour = ethnicity), size = 2) +
  geom_line(aes(x = number.seq, y = number.ll95), data = dfCI) +
  geom_line(aes(x = number.seq, y = number.ul95), data = dfCI) +
  geom_line(aes(x = number.seq, y = number.ll999), linetype = "dashed", data = dfCI) +
  geom_line(aes(x = number.seq, y = number.ul999), linetype = "dashed", data = dfCI) +
  #xlim(min(dfCI$number.seq), max(dfCI$number.seq)) +
  #ylim(min(dfCI$number.ll999), max(dfCI$number.ul999)) +
  xlab("Expected number of treated patients") + 
  ylab("Observed to expected ratio of treated patients") + 
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank()) +
  #guides(shape = "none") +
  geom_segment(aes(min(dfCI$number.seq), xend =  max(dfCI$number.seq), 
                   y = overall$y, yend = overall$y),
               colour = "steelblue2")

```


# Conclusions
* Several variables appear to be associated with receiving treatment 
* Even after adjustment for clinical and demographic variables, there was wide variation in O/E ratios for high risk groups and regions, suggesting that there are large differences in these groups with respect to receiving treatment and that relatively little of the observed variation can be explained by these variables considered in the adjusted model.

# Limitations
* O:E ratios should be used only to compare each group to the average - they are not, in theory, suitable for comparisons across groups with different patient mixes, as they are standardised to the mix of the group under evaluation

# Next steps
* Write up as is OR
* Develop "better" model
    - Minimal assessment made of variables included in models
    - All variables included in final model and no interaction terms considered






