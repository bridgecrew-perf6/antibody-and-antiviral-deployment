---
title: SGTF availability among non-hospitalised patients with COVID-19 eligible for antivirals and neutralising monoclonal antibodies
output:
  html_document:
  theme: journal
github_document:
  keep_html: TRUE
---
  
```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}
pre[class] {
  max-height: 200px;
}
```

<style>
  body {
    text-align: justify;
     font-size: 11pt}
</style>

  
```{r setup, include=FALSE}
# Document settings ----
knitr::opts_chunk$set(echo = TRUE)

# Preliminaries ----

## Import libraries
library(tidyverse)
library(here)
library(glue)
library(gt)
library(gtsummary)
library(reshape2)
library(stringr)
library(kableExtra)
library(knitr)
library(ggplot2)
library(png)
library(readr)
library(htmltools)
library(scales)

## Import custom user functions
source(here("analysis", "lib", "custom_functions.R"))

## Create directory
dir.create(here::here("output", "coverage", "counts"), showWarnings = FALSE, recursive=TRUE)

## Redaction threshold
threshold = 8

## Import data
data_processed <- read_rds(here::here("output", "data", "data_processed_clean.rds"))

## End date
end_date <- max(data_processed$start_date, na.rm = T)

## Remove patients no longer registered at time of treatment and format variables
data_processed_clean <- data_processed %>%
  filter(has_died == 0,
         registered_eligible == 1 | registered_treated == 1) %>%
  mutate(
    
    # Age groups
    ageband = cut(
      age,
      breaks = c(12, 30, 40, 50, 60, 70, 80, Inf),
      labels = c("12-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+"),
      right = FALSE),
    
    # Vaccination status
    vaccination_status = fct_case_when(
      vaccination_status == "Un-vaccinated" ~ "Un-vaccinated",
      vaccination_status == "Un-vaccinated (declined)" ~ "Un-vaccinated (declined)",
      vaccination_status== "One vaccination" ~ "One vaccination",
      vaccination_status == "Two vaccinations" ~ "Two vaccinations",
      vaccination_status == "Three or more vaccinations" ~ "Three or more vaccinations",
      #TRUE ~ "Unknown",
      TRUE ~ NA_character_
    ),
    
    # Treated status
    treated_status = ifelse(!is.na(treatment_type), "treated", "not treated"),
    
    # Censoring
    start_date = coalesce(covid_test_positive_date, treatment_date),
    study_end = end_date
  )


```


## Simple summaires of SGTF data

## covid_first_test_positive_date versus covid_test_positive_date
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_processed_clean[,c("covid_first_test_positive_date", "covid_test_positive_date")]))

# Date ranges
data_processed_clean %>% 
  select(covid_first_test_positive_date, covid_test_positive_date) %>%
  summary()

# Same date
data_processed_clean %>%
  filter(covid_first_test_positive_date == covid_test_positive_date) %>%
  nrow()

# covid_first_test_positive_date but no covid_test_positive_date (bias because of study pop inclusion criteria)
data_processed_clean %>%
  filter(!is.na(covid_first_test_positive_date),
         is.na(covid_test_positive_date)) %>%
  nrow()

```

## sgft versus sgtf_first
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_processed_clean[,c("sgtf_first", "sgtf")]))

full_join(data_processed_clean %>% 
            select(sgtf_first) %>%
            group_by(sgtf_first) %>%
            tally() %>%
            select(value = sgtf_first, n_sgtf_first = n),
          data_processed_clean %>% 
            select(sgtf) %>%
            group_by(sgtf) %>%
            tally() %>%
            select(value = sgtf, n_sgtf = n),
          by = "value")

```

## covid_first_test_positive_date versus sgtf_first
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_processed_clean[,c("covid_first_test_positive_date", "sgtf_first")]))

# covid_first_test_positive_date (present/absent) versus sgtf_first
data_processed_clean %>% 
  select(covid_first_test_positive_date, sgtf_first) %>%
  mutate(covid_first_test_positive_date = ifelse(is.na(covid_first_test_positive_date), 0 ,1)) %>%
  group_by(covid_first_test_positive_date, sgtf_first) %>%
  tally()

```

## covid_first_test_positive_date versus sgtf_first
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_processed_clean[,c("covid_test_positive_date", "sgtf")]))

# covid_first_test_positive_date (present/absent) versus sgtf_first
data_processed_clean %>% 
  select(covid_test_positive_date, sgtf) %>%
  mutate(covid_test_positive_date = ifelse(is.na(covid_test_positive_date), 0 ,1)) %>%
  group_by(covid_test_positive_date, sgtf) %>%
  tally()

```



<br>



Between **`r format(min(data_processed_clean$start_date, na.rm = T), format = "%d-%b-%Y")`** and **`r format(max(data_processed_clean$start_date, na.rm = T), format = "%d-%b-%Y")`**, a total of `r format(plyr::round_any(nrow(data_processed_clean), 5), big.mark = ",", scientific = FALSE)` non-hospitalised patients registered at a TPP practice in England were identified as potentially being eligible for receiving an antiviral or nMAB for treating COVID-19. Of these `r format(plyr::round_any(nrow(data_processed_clean), 5), big.mark = ",", scientific = FALSE)` potentially eligible patients, `r format(plyr::round_any(nrow(data_processed_clean %>% filter(!is.na(sgtf))), 5), big.mark = ",", scientific = FALSE)` (**`r round(nrow(data_processed_clean %>% filter(!is.na(sgtf)))/nrow(data_processed_clean)*100, digits = 0)`%**) had S-gene target failure data available via Second Generation Surveillance System (SGSS) data, which captures routine laboratory surveillance data on infectious diseases across England. Table 1 shows the breakdown of SGTF availability in eligible patients, stratified by treatment status. 

**Table 1 Breakdown of SGTF availability in eligible patients, stratified by treatment status.**

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%'}

data_processed_clean %>%
  mutate(patient = 1,
         
         treated_status = ifelse(!is.na(treatment_type), "Treated", "Untreated"),
         
         sgtf = fct_case_when(
           sgtf == "1" ~ "Cases with SGTF",
           sgtf == "0" ~ "Detectable S-gene",
           sgtf == "8" ~ "Classified as 8",
           sgtf == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable"),
         
         sgtf_first = fct_case_when(
           sgtf_first == "1" ~ "Cases with SGTF",
           sgtf_first == "0" ~ "Detectable S-gene",
           sgtf_first == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")
         ) %>%
  select(treated_status, `All Tests Dataset` = sgtf, `Earliest Specimen Dataset` = sgtf_first) %>%
  tbl_summary(by = treated_status) %>%
  add_overall() %>%
  modify_header(label ~ "**S-gene target failure data**") %>%
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Treatment status**") %>%
  bold_labels()

```

<br>






