---
title: S-gene Target Failure data in OpenSAFELY
output:
  html_document:
  theme: journal
github_document:
  keep_html: TRUE
---
  
```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}
pre[class] {
  max-height: 200px;
}
```

<style>
  body {
    text-align: justify;
     font-size: 11pt}
</style>

  
```{r setup, include=FALSE}

# Document settings ----
knitr::opts_chunk$set(echo = TRUE)


# Preliminaries ----

## Import libraries
library(tidyverse)
library(here)
library(glue)
library(gt)
library(gtsummary)
library(reshape2)
library(stringr)
library(scales)
library(kableExtra)
library(knitr)
library(ggplot2)
library(png)
library(readr)
library(htmltools)

## Custom functions
source(here("analysis", "lib", "custom_functions.R"))

## Create directory
dir.create(here::here("output", "coverage"), showWarnings = FALSE, recursive=TRUE)

## Redaction threshold
threshold = 8


# Process data ----

## Read in data (don't rely on defaults)
data_sgtf <- read_csv(
  here::here("output", "data", "input_sgtf.csv.gz"),
  col_types = cols_only(                      
    
    # PATIENT ID ----
    patient_id = col_integer(),
    
    # POSITIVE SARS-CoV-2 TEST RESULTS ----
    covid_first_test_positive_date_alltests = col_date(format = "%Y-%m-%d"),
    covid_first_test_positive_date_earliestspecimen = col_date(format = "%Y-%m-%d"),
    covid_latest_test_positive_date_alltests = col_date(format = "%Y-%m-%d"),
    covid_latest_test_positive_date_earliestspecimen = col_date(format = "%Y-%m-%d"),
    
    # COUNTS OF POSITIVE TESTS
    tests_conducted_positive_alltests = col_integer(),
    
    # S-GENE TARGET FAILURE Target
    sgtf_first_alltests = col_character(),
    sgtf_first_earliestspecimen = col_character(),                  
    sgtf_latest_alltests = col_character(),   
    sgtf_latest_earliestspecimen = col_character(),  
    
    sgtf_first_covid_test_date_alltests = col_character(),
    sgtf_first_covid_test_date_earliestspecimen = col_character(),
    sgtf_latest_covid_test_date_alltests = col_character(),
    sgtf_latest_covid_test_date_earliestspecimen = col_character(),
    
    # CASE CATEGORY (type of test used)
    covid_positive_test_type_earliestspecimen = col_character(), 
    
    # COVID VARIENT
    variant_first_alltests = col_character(),                    
    variant_latest_alltests = col_character()
    
  ),
)

```


## Comparisons of positive SARS-CoV-2 test dates 

### First positive SARS-CoV-2 test date
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("covid_first_test_positive_date_earliestspecimen", "covid_first_test_positive_date_alltests")]))

# Date ranges
data_sgtf %>% 
  select(covid_first_test_positive_date_earliestspecimen, covid_first_test_positive_date_alltests) %>%
  summary()

# Same date
data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen == covid_first_test_positive_date_alltests) %>%
  nrow()

# Different date
data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen != covid_first_test_positive_date_alltests) %>%
  nrow()

# Date in earliest specimen dataset but not in all tests dataset
data_sgtf %>%
  filter(!is.na(covid_first_test_positive_date_earliestspecimen),
         is.na(covid_first_test_positive_date_alltests)) %>%
  nrow()

# No date in earliest specimen dataset but date in all tests dataset
data_sgtf %>%
  filter(is.na(covid_first_test_positive_date_earliestspecimen),
         !is.na(covid_first_test_positive_date_alltests)) %>%
  nrow()

```

### Latest positive SARS-CoV-2 test date
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("covid_latest_test_positive_date_earliestspecimen", "covid_latest_test_positive_date_alltests")]))

# Date ranges
data_sgtf %>% 
  select(covid_latest_test_positive_date_earliestspecimen, covid_latest_test_positive_date_alltests) %>%
  summary()

# Same date
data_sgtf %>%
  filter(covid_latest_test_positive_date_earliestspecimen == covid_latest_test_positive_date_alltests) %>%
  nrow()

# Different date
data_sgtf %>%
  filter(covid_latest_test_positive_date_earliestspecimen != covid_latest_test_positive_date_alltests) %>%
  nrow()

# Date in earliest specimen dataset but not in all tests dataset
data_sgtf %>%
  filter(!is.na(covid_latest_test_positive_date_earliestspecimen),
         is.na(covid_latest_test_positive_date_alltests)) %>%
  nrow()

# No date in earliest specimen dataset but date in all tests dataset
data_sgtf %>%
  filter(is.na(covid_latest_test_positive_date_earliestspecimen),
         !is.na(covid_latest_test_positive_date_alltests)) %>%
  nrow()

```

### Earliest specimen SARS-CoV-2 positive test dates
```{r, message=FALSE, warning=FALSE}

# Same date
data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen == covid_latest_test_positive_date_earliestspecimen) %>%
  nrow()

# Different date
data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen != covid_latest_test_positive_date_earliestspecimen) %>%
  nrow()

```

### Distribution of SARS-CoV-2 positive test results
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%', fig.cap = "**Figure 1 Distribution of the the number of positive SARS-CoV-2 tests individals have recorded.** Note, this is only available for the positive tests in the _All Tests Dataset_ and no attempts have been made to define epidsodes therefore it is posible that individuals have multiple positive test results for the same infection.", fig.topcaption=TRUE}

data_sgtf %>%
  select(patient_id, tests_conducted_positive_alltests) %>%
  mutate(tests_conducted_positive_alltests = ifelse(is.na(tests_conducted_positive_alltests), 0, tests_conducted_positive_alltests)) %>%
  group_by(tests_conducted_positive_alltests) %>%
  summarise(n_pos_tests = n()) %>%
  filter(n_pos_tests >= 5) %>%
  ggplot(aes(x = tests_conducted_positive_alltests, y = n_pos_tests)) +
  geom_col() +
  theme_bw() +
  labs(x = "Number of positive SARS-CoV-2 test results", y = "Frequency")

```


## Comparisons of S-gene target failure data

### First SGTF result
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("sgtf_first_earliestspecimen", "sgtf_first_alltests")]))

## Values
tbls <- list(data_sgtf %>%
  select(`S-gene target failure` = sgtf_first_earliestspecimen) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  select(`S-gene target failure` = sgtf_first_alltests) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())
  
tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))
```

### SGTF on first positive test date
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("sgtf_first_covid_test_date_earliestspecimen", "sgtf_first_covid_test_date_alltests")]))

tbls <- list(data_sgtf %>%
  select(`S-gene target failure` = sgtf_first_covid_test_date_earliestspecimen,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  select(`S-gene target failure` = sgtf_first_covid_test_date_alltests,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())
  
tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))

## Restricted to those with same positive test date
tbls <- list(data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen == covid_first_test_positive_date_alltests) %>%
  select(`S-gene target failure` = sgtf_first_covid_test_date_earliestspecimen,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen == covid_first_test_positive_date_alltests) %>%
  select(`S-gene target failure` = sgtf_first_covid_test_date_alltests,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())

tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))

```

### Latest SGTF result
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("sgtf_latest_covid_test_date_earliestspecimen", "sgtf_latest_covid_test_date_alltests")]))

tbls <- list(data_sgtf %>%
  select(`S-gene target failure` = sgtf_latest_covid_test_date_earliestspecimen,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  select(`S-gene target failure` = sgtf_latest_covid_test_date_alltests,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())
  
tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))

## Restricted to those with same positive test date
tbls <- list(data_sgtf %>%
  filter(covid_latest_test_positive_date_earliestspecimen == covid_latest_test_positive_date_alltests) %>%
  select(`S-gene target failure` = sgtf_latest_covid_test_date_earliestspecimen,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  filter(covid_latest_test_positive_date_earliestspecimen == covid_latest_test_positive_date_alltests) %>%
  select(`S-gene target failure` = sgtf_latest_covid_test_date_alltests,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())

tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))

```


## Trends in S gene target failure
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%', fig.show='hold' , fig.cap = "**Figure 2 Number of COVID-19 cases with S gene positive/SGTF among those tested by week as of 6 June 2022, overall (a) and by region (b).** Note, this is only available for the positive tests in the _All Tests Dataset_ and no attempts have been made to define epidsodes therefore it is posible that individuals have multiple test results for the same infection and here we are only capturing the result for the first record that appears in that week.", fig.topcaption=TRUE}

# SGTF plot
weekly_sgtf_counts <- read_rds(here::here("output", "data", "weekly_sgtf_counts.rds"))

weekly_sgtf_counts %>%
  ggplot(aes(x = week, y = count_redacted, fill = sgtf_alltests)) +
  geom_bar(stat='identity') +
  theme_bw() +
  scale_x_date(date_breaks = "2 month", date_labels =  "%d %b %Y") +
  labs(x = "Test date (week commencing)", y = "Count", title = "(a)") +
  theme(
    legend.position = "bottom", 
    legend.title = element_blank(),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 10),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank()) + 
  scale_y_continuous(labels = comma) +
  scale_fill_brewer(palette="Pastel1")

# SGTF plot by region
weekly_sgtf_counts_by_region <- read_rds(here::here("output", "data", "weekly_sgtf_counts_by_region.rds"))

weekly_sgtf_counts_by_region %>%
  ggplot(aes(x = week, y = count_redacted, fill = sgtf_alltests)) +
  geom_bar(stat='identity') +
  theme_bw() +
  facet_wrap(~region_nhs) +
  scale_x_date(date_breaks = "2 month", date_labels =  "%d %b %Y") +
  labs(x = "Test date (week commencing)", y = "Count", title = "(b)") +
  theme(
    legend.position = "bottom", 
    legend.title = element_blank(),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 10),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank()) + 
  scale_y_continuous(labels = comma) +
  scale_fill_brewer(palette="Pastel1")

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%', fig.show='hold' , fig.cap = "**Figure 3 Weekly number (bars) and proportion (line) of COVID-19 cases with SGTF among those tested and with S gene detection results (1 March 2020 to 6 June 2022).** Note, this is only available for the positive tests in the _All Tests Dataset_ and no attempts have been made to define epidsodes therefore it is posible that individuals have multiple test results for the same infection and here we are only capturing the result for the first record that appears in that week.", fig.topcaption=TRUE}

# SGTF plot
weekly_sgtf_counts_perc <- weekly_sgtf_counts %>%
  filter(sgtf_alltests %in% c("Cases with SGTF", "Detectable S-gene")) %>%
  group_by(week) %>%
  mutate(total = sum(count_redacted, na.rm = T),
         perc = count_redacted/total*100)

tot_obs <- max(weekly_sgtf_counts_perc$total, na.rm = T)

weekly_sgtf_counts_perc %>%
  ggplot(aes(x = week, y = count_redacted, fill = sgtf_alltests)) +
  geom_bar(stat='identity') +
  geom_line(data = (weekly_sgtf_counts_perc %>% filter(sgtf_alltests == "Cases with SGTF")), aes(y = perc), color = "red") +
  scale_y_continuous(labels = comma,
                     sec.axis = sec_axis(trans = ~./tot_obs, labels = percent, 
                                           name = "Percent")) +
  theme_bw() +
  scale_x_date(date_breaks = "2 month", date_labels =  "%d %b %Y") +
  labs(x = "Test date (week commencing)", y = "Count", title = "(a)") +
  theme(
    legend.position = "bottom", 
    legend.title = element_blank(),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 10),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank()) + 
  scale_fill_brewer(palette = "Blues")

# SGTF plot by region
weekly_sgtf_counts_by_region_perc <- weekly_sgtf_counts_by_region %>%
  filter(sgtf_alltests %in% c("Cases with SGTF", "Detectable S-gene")) %>%
  group_by(week, region_nhs) %>%
  mutate(total = sum(count_redacted, na.rm = T),
         perc = count_redacted/total*100)

tot_obs <- max(weekly_sgtf_counts_by_region_perc$total, na.rm = T)

weekly_sgtf_counts_by_region_perc %>%
  ggplot(aes(x = week, y = count_redacted, fill = sgtf_alltests)) +
  geom_bar(stat='identity') +
  geom_line(data = (weekly_sgtf_counts_by_region_perc %>% filter(sgtf_alltests == "Cases with SGTF")), aes(y = perc), color = "red") +
  facet_wrap(~region_nhs) +
  scale_y_continuous(labels = comma,
                     sec.axis = sec_axis(trans = ~./tot_obs, labels = percent, 
                                           name = "Percent")) +
  theme_bw() +
  scale_x_date(date_breaks = "2 month", date_labels =  "%d %b %Y") +
  labs(x = "Test date (week commencing)", y = "Count", title = "(b)") +
  theme(
    legend.position = "bottom", 
    legend.title = element_blank(),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 10),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank()) + 
  scale_fill_brewer(palette = "Blues")


```