---
title: S-gene Target Failure data in OpenSAFELY
output:
  html_document:
  theme: journal
github_document:
  keep_html: TRUE
---
  
```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}
pre[class] {
  max-height: 200px;
}
```

<style>
  body {
    text-align: justify;
     font-size: 11pt}
</style>

  
```{r setup, include=FALSE}

# Document settings ----
knitr::opts_chunk$set(echo = TRUE)


# Preliminaries ----

## Import libraries
library(tidyverse)
library(here)
library(glue)
library(gt)
library(gtsummary)
library(reshape2)
library(stringr)
library(scales)
library(kableExtra)
library(knitr)
library(ggplot2)
library(png)
library(readr)
library(htmltools)

## Custom functions
source(here("analysis", "lib", "custom_functions.R"))

## Create directory
dir.create(here::here("output", "coverage"), showWarnings = FALSE, recursive=TRUE)

## Redaction threshold
threshold = 8


# Process data ----

## Read in data (don't rely on defaults)
data_sgtf <- read_csv(
  here::here("output", "data", "input_sgtf.csv.gz"),
  col_types = cols_only(                      
    
    # PATIENT ID ----
    patient_id = col_integer(),
    
    # POSITIVE SARS-CoV-2 TEST RESULTS ----
    covid_first_test_positive_date_alltests = col_date(format = "%Y-%m-%d"),
    covid_first_test_positive_date_earliestspecimen = col_date(format = "%Y-%m-%d"),
    covid_latest_test_positive_date_alltests = col_date(format = "%Y-%m-%d"),
    covid_latest_test_positive_date_earliestspecimen = col_date(format = "%Y-%m-%d"),
    
    # COUNTS OF POSITIVE TESTS
    tests_conducted_positive_alltests = col_integer(),
    
    # S-GENE TARGET FAILURE Target
    sgtf_first_alltests = col_character(),
    sgtf_first_earliestspecimen = col_character(),                  
    sgtf_latest_alltests = col_character(),   
    sgtf_latest_earliestspecimen = col_character(),  
    
    sgtf_first_covid_test_date_alltests = col_character(),
    sgtf_first_covid_test_date_earliestspecimen = col_character(),
    sgtf_latest_covid_test_date_alltests = col_character(),
    sgtf_latest_covid_test_date_earliestspecimen = col_character(),
    
    # CASE CATEGORY (type of test used)
    covid_positive_test_type_earliestspecimen = col_character(), 
    
    # COVID VARIENT
    variant_first_alltests = col_character(),                    
    variant_latest_alltests = col_character()
    
  ),
)

```


# Data availability (comparisons between earliest specimen dataset and all tests dataset)

## Comparisons of positive SARS-CoV-2 test dates 

### First positive SARS-CoV-2 test date
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("covid_first_test_positive_date_earliestspecimen", "covid_first_test_positive_date_alltests")]))

# Date ranges
data_sgtf %>% 
  select(covid_first_test_positive_date_earliestspecimen, covid_first_test_positive_date_alltests) %>%
  summary()

# Same date
data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen == covid_first_test_positive_date_alltests) %>%
  nrow()

# Different date
data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen != covid_first_test_positive_date_alltests) %>%
  nrow()

# Date in earliest specimen dataset but not in all tests dataset
data_sgtf %>%
  filter(!is.na(covid_first_test_positive_date_earliestspecimen),
         is.na(covid_first_test_positive_date_alltests)) %>%
  nrow()

# No date in earliest specimen dataset but date in all tests dataset
data_sgtf %>%
  filter(is.na(covid_first_test_positive_date_earliestspecimen),
         !is.na(covid_first_test_positive_date_alltests)) %>%
  nrow()

```

### Latest positive SARS-CoV-2 test date
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("covid_latest_test_positive_date_earliestspecimen", "covid_latest_test_positive_date_alltests")]))

# Date ranges
data_sgtf %>% 
  select(covid_latest_test_positive_date_earliestspecimen, covid_latest_test_positive_date_alltests) %>%
  summary()

# Same date
data_sgtf %>%
  filter(covid_latest_test_positive_date_earliestspecimen == covid_latest_test_positive_date_alltests) %>%
  nrow()

# Different date
data_sgtf %>%
  filter(covid_latest_test_positive_date_earliestspecimen != covid_latest_test_positive_date_alltests) %>%
  nrow()

# Date in earliest specimen dataset but not in all tests dataset
data_sgtf %>%
  filter(!is.na(covid_latest_test_positive_date_earliestspecimen),
         is.na(covid_latest_test_positive_date_alltests)) %>%
  nrow()

# No date in earliest specimen dataset but date in all tests dataset
data_sgtf %>%
  filter(is.na(covid_latest_test_positive_date_earliestspecimen),
         !is.na(covid_latest_test_positive_date_alltests)) %>%
  nrow()

```

### Earliest specimen SARS-CoV-2 positive test dates
```{r, message=FALSE, warning=FALSE}

# Same date
data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen == covid_latest_test_positive_date_earliestspecimen) %>%
  nrow()

# Different date
data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen != covid_latest_test_positive_date_earliestspecimen) %>%
  nrow()

```

### Distribution of SARS-CoV-2 positive test results
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%', fig.cap = "**Figure 1 Distribution of the the number of positive SARS-CoV-2 tests individals have recorded.** Note, this is only available for the positive tests in the _All Tests Dataset_ and no attempts have been made to define epidsodes therefore it is posible that individuals have multiple positive test results for the same infection.", fig.topcaption=TRUE}

data_sgtf %>%
  select(patient_id, tests_conducted_positive_alltests) %>%
  mutate(tests_conducted_positive_alltests = ifelse(is.na(tests_conducted_positive_alltests), 0, tests_conducted_positive_alltests)) %>%
  group_by(tests_conducted_positive_alltests) %>%
  summarise(n_pos_tests = n()) %>%
  filter(n_pos_tests >= 5) %>%
  ggplot(aes(x = tests_conducted_positive_alltests, y = n_pos_tests)) +
  geom_col() +
  theme_bw() +
  labs(x = "Number of positive SARS-CoV-2 test results", y = "Frequency")

```


## Comparisons of S-gene target failure data

### First SGTF result
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("sgtf_first_earliestspecimen", "sgtf_first_alltests")]))

## Values
tbls <- list(data_sgtf %>%
  select(`S-gene target failure` = sgtf_first_earliestspecimen) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  select(`S-gene target failure` = sgtf_first_alltests) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())
  
tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))
```

### SGTF on first positive test date
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("sgtf_first_covid_test_date_earliestspecimen", "sgtf_first_covid_test_date_alltests")]))

tbls <- list(data_sgtf %>%
  select(`S-gene target failure` = sgtf_first_covid_test_date_earliestspecimen,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  select(`S-gene target failure` = sgtf_first_covid_test_date_alltests,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())
  
tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))

## Restricted to those with same positive test date
tbls <- list(data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen == covid_first_test_positive_date_alltests) %>%
  select(`S-gene target failure` = sgtf_first_covid_test_date_earliestspecimen,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  filter(covid_first_test_positive_date_earliestspecimen == covid_first_test_positive_date_alltests) %>%
  select(`S-gene target failure` = sgtf_first_covid_test_date_alltests,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())

tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))

```

### Latest SGTF result
```{r, message=FALSE, warning=FALSE}

# Counts
colSums(!is.na(data_sgtf[,c("sgtf_latest_covid_test_date_earliestspecimen", "sgtf_latest_covid_test_date_alltests")]))

tbls <- list(data_sgtf %>%
  select(`S-gene target failure` = sgtf_latest_covid_test_date_earliestspecimen,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  select(`S-gene target failure` = sgtf_latest_covid_test_date_alltests,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())
  
tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))

## Restricted to those with same positive test date
tbls <- list(data_sgtf %>%
  filter(covid_latest_test_positive_date_earliestspecimen == covid_latest_test_positive_date_alltests) %>%
  select(`S-gene target failure` = sgtf_latest_covid_test_date_earliestspecimen,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary(),
  data_sgtf %>%
  filter(covid_latest_test_positive_date_earliestspecimen == covid_latest_test_positive_date_alltests) %>%
  select(`S-gene target failure` = sgtf_latest_covid_test_date_alltests,) %>%
  mutate(`S-gene target failure` = fct_case_when(
           `S-gene target failure` == "1" ~ "Cases with SGTF",
           `S-gene target failure` == "0" ~ "Detectable S-gene",
           `S-gene target failure` == "8" ~ "Classified as 8",
           `S-gene target failure` == "9" ~ "Unclassifiable",
           TRUE ~ "Not avaliable")) %>%
  tbl_summary())

tbl_merge(tbls, tab_spanner = c("**Earliest Specimen Dataset**", "**All Tests Dataset**"))

```


## Trends in S gene target failure
```{r, echo=FALSE, message=FALSE, warning=FALSE}

## Input file names
input.files = list.files(path = here::here("output", "data"), pattern = "input_sgtf_weekly_")

print(input.files)

# Date range
start <- as.Date(substr(input.files[1], 19,28))
end <- as.Date(substr(input.files[length(input.files)], 19,28)) + 6

# Totals table
totals <- read_rds(here::here("output", "data", "weekly_sgtf_counts.rds")) %>%
  group_by(sgtf_alltests) %>%
  summarise(count_redacted = sum(count_redacted, na.rm = T)) %>%
  select(`S-gene target failure` = sgtf_alltests, n = count_redacted) %>%
  mutate(Total = sum(n, na.rm = T),
         `%` = round(n/Total*100, digits = 0)) %>%
  select(-Total)

totals_region <- read_rds(here::here("output", "data", "weekly_sgtf_counts_by_region.rds")) %>%
  group_by(sgtf_alltests, region_nhs) %>%
  summarise(count_redacted = sum(count_redacted, na.rm = T)) %>%
  select(`S-gene target failure` = sgtf_alltests, region_nhs, n = count_redacted) %>%
  mutate(Total = sum(n, na.rm = T),
         `%` = round(n/Total*100, digits = 0)) %>%
  select(-Total)

# Weekly proportions
weekly_prop <- read_rds(here::here("output", "data", "weekly_sgtf_counts.rds")) %>%
  group_by(week) %>%
  mutate(total = sum(count_redacted, na.rm = T)) %>%
  ungroup() %>%
  mutate(perc = round(count_redacted/total*100, digits = 0)) %>%
  filter(sgtf_alltests == "Not avaliable") %>%
  mutate(perc_tested = 100 - perc)

min_weekly_prop <- min(weekly_prop$perc_tested, na.rm = T)
max_weekly_prop <- max(weekly_prop$perc_tested, na.rm = T)

```

#### Overview

Descriptive analyses below are restricted to SGTF data available for the positive tests in the _All Tests Dataset_ and no attempts have been made to define episodes. It is therefore possible that individuals have multiple test results for the same infection and here we are only capturing the result for the first record that appears in that week.

The following definitions for S-gene target failure apply:

+ **Cases with SGTF** 1: Isolate with confirmed SGTF, Undetectable S gene; CT value (CH3) =0, Detectable ORF1ab gene; CT value (CH2) <=30 and >0, Detectable N gene; CT value (CH1) <=30 and >0

+ **Detectable S-gene** 0: S gene detected, Detectable S gene (CH3>0), Detectable y ORF1ab CT value (CH1) <=30 and >0, Detectable N gene CT value (CH2) <=30 and >0

+ **Classified as 8"** 8: Unknown definition

+ **Unclassifiable** 9: Cannot be classified. Note, it's possible that some/all LFTs are currently also coming across as 9.
clearly this is a PCR only variable.

+ **Not avaliable** Null: Target is not S Gene. 

<br>

<!-- #### Results -->
<!-- Between **`r format(start, format = "%d-%b-%Y")`** and **`r format(end, format = "%d-%b-%Y")`**, of all (first weekly) positive SARS-CoV-2 tests available in OpenSAFELY from Second Generation Surveillance System (SGSS) data which captures routine laboratory surveillance data on infectious diseases across England, about `r 100 - as.numeric(totals[5,3])`% had SGTF data available; -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE} -->

<!--  data_extract <- read_csv( -->
<!--     here::here("output", "data", "input_sgtf_weekly_2020-03-01.csv.gz")) -->

<!-- table(data_extract$sgtf_alltests) -->

<!--  totals %>% -->
<!--   kable(row.names = FALSE, -->
<!--         align = c("l", rep("r", 2)), -->
<!--         booktabs=TRUE) %>% -->
<!--   kable_styling(position = "center", full_width = F, bootstrap_options = "striped", font_size = 10) -->

<!-- ``` -->

<!-- During this period, the weekly proportion of specimens tested has fluctuated between approximately `r min_weekly_prop`% and `r max_weekly_prop`%, with coverage varying by region (Figure 1). Figure 2 shows how the number of cases with SGTF has fluctuated over time and Figure 3 shows proportion of COVID-19 cases with SGTF among those with S gene detection results. Cases by age and sex are displayed (Table 1). Note, trends in SGTF over space and time are affected by the coverage of laboratories contributing to this surveillance data. -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', out.width = '50%', fig.show='hold' , fig.cap = "**Figure 1 Proportion of specimens tested by A) week and B) region.**", fig.topcaption=TRUE} -->

<!-- # SGTF plot -->
<!-- read_rds(here::here("output", "data", "weekly_sgtf_counts.rds")) %>% -->
<!--   group_by(week) %>% -->
<!--   mutate(total = sum(count_redacted, na.rm = T)) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(perc = round(count_redacted/total*100, digits = 0)) %>% -->
<!--   filter(sgtf_alltests == "Not avaliable") %>% -->
<!--   mutate(perc_tested = 100 - perc) %>% -->
<!--   ggplot(aes(x = week, y = perc_tested)) + -->
<!--   geom_line(colour = "blue") + -->
<!--   theme_bw() + -->
<!--   scale_x_date(date_breaks = "2 month", date_labels =  "%d %b %Y") + -->
<!--   labs(x = "Test date (week commencing)", y = "Percentage of specimens tested", title = "(a)") + -->
<!--   theme( -->
<!--     axis.text = element_text(size = 10), -->
<!--     axis.text.x = element_text(angle = 60, hjust = 1), -->
<!--     axis.title = element_text(size = 10), -->
<!--     axis.line.x = element_line(colour = "black"), -->
<!--     panel.grid.minor.x = element_blank()) -->

<!-- read_rds(here::here("output", "data", "weekly_sgtf_counts_by_region.rds")) %>% -->
<!--   filter(!is.na(region_nhs)) %>% -->
<!--   group_by(week, region_nhs) %>% -->
<!--   mutate(total = sum(count_redacted, na.rm = T)) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(perc = round(count_redacted/total*100, digits = 0)) %>% -->
<!--   filter(sgtf_alltests == "Not avaliable") %>% -->
<!--   mutate(perc_tested = 100 - perc) %>% -->
<!--   ggplot(aes(x = week, y = perc_tested, colour = region_nhs)) + -->
<!--   geom_line() + -->
<!--   facet_wrap(~region_nhs) + -->
<!--   theme_bw() + -->
<!--   scale_x_date(date_breaks = "3 month", date_labels =  "%d %b %Y") + -->
<!--   labs(x = "Test date (week commencing)", y = "Percentage of specimens tested", title = "(b)")+ -->
<!--   theme( -->
<!--     legend.position = "bottom",  -->
<!--     legend.title = element_blank(), -->
<!--     axis.text = element_text(size = 10), -->
<!--     axis.text.x = element_text(angle = 60, hjust = 1), -->
<!--     axis.title = element_text(size = 10), -->
<!--     axis.line.x = element_line(colour = "black"), -->
<!--     panel.grid.minor.x = element_blank()) -->

<!-- ``` -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%', fig.show='hold' , fig.cap = "**Figure 2 Number of COVID-19 cases with S gene positive/SGTF among those tested by week as of 6 June 2022, overall (a) and by region (b).** Note, this is only available for the positive tests in the _All Tests Dataset_ and no attempts have been made to define epidsodes therefore it is posible that individuals have multiple test results for the same infection and here we are only capturing the result for the first record that appears in that week.", fig.topcaption=TRUE} -->

<!-- # SGTF plot -->
<!-- weekly_sgtf_counts <- read_rds(here::here("output", "data", "weekly_sgtf_counts.rds")) -->

<!-- weekly_sgtf_counts %>% -->
<!--   ggplot(aes(x = week, y = count_redacted, fill = sgtf_alltests)) + -->
<!--   geom_bar(stat='identity') + -->
<!--   theme_bw() + -->
<!--   scale_x_date(date_breaks = "2 month", date_labels =  "%d %b %Y") + -->
<!--   labs(x = "Test date (week commencing)", y = "Count", title = "(a)") + -->
<!--   theme( -->
<!--     legend.position = "bottom",  -->
<!--     legend.title = element_blank(), -->
<!--     axis.text = element_text(size = 10), -->
<!--     axis.text.x = element_text(angle = 60, hjust = 1), -->
<!--     axis.title = element_text(size = 10), -->
<!--     axis.line.x = element_line(colour = "black"), -->
<!--     panel.grid.minor.x = element_blank()) +  -->
<!--   scale_y_continuous(labels = comma) + -->
<!--   scale_fill_brewer(palette="Pastel1") -->

<!-- # SGTF plot by region -->
<!-- weekly_sgtf_counts_by_region <- read_rds(here::here("output", "data", "weekly_sgtf_counts_by_region.rds")) -->

<!-- weekly_sgtf_counts_by_region %>% -->
<!--   filter(!is.na(region_nhs)) %>% -->
<!--   ggplot(aes(x = week, y = count_redacted, fill = sgtf_alltests)) + -->
<!--   geom_bar(stat='identity') + -->
<!--   theme_bw() + -->
<!--   facet_wrap(~region_nhs, ncol = 3) + -->
<!--   scale_x_date(date_breaks = "2 month", date_labels =  "%d %b %Y") + -->
<!--   labs(x = "Test date (week commencing)", y = "Count", title = "(b)") + -->
<!--   theme( -->
<!--     legend.position = "bottom",  -->
<!--     legend.title = element_blank(), -->
<!--     axis.text = element_text(size = 10), -->
<!--     axis.text.x = element_text(angle = 60, hjust = 1), -->
<!--     axis.title = element_text(size = 10), -->
<!--     axis.line.x = element_line(colour = "black"), -->
<!--     panel.grid.minor.x = element_blank()) +  -->
<!--   scale_y_continuous(labels = comma) + -->
<!--   scale_fill_brewer(palette="Pastel1") -->

<!-- ``` -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%', fig.show='hold' , fig.cap = "**Figure 3 Weekly number (bars) and proportion (line) of COVID-19 cases with SGTF among those tested and with S gene detection results (1 March 2020 to 6 June 2022).** Note, this is only available for the positive tests in the _All Tests Dataset_ and no attempts have been made to define epidsodes therefore it is posible that individuals have multiple test results for the same infection and here we are only capturing the result for the first record that appears in that week.", fig.topcaption=TRUE} -->

<!-- # SGTF plot -->
<!-- weekly_sgtf_counts_perc <- weekly_sgtf_counts %>% -->
<!--   filter(sgtf_alltests %in% c("Cases with SGTF", "Detectable S-gene")) %>% -->
<!--   group_by(week) %>% -->
<!--   mutate(total = sum(count_redacted, na.rm = T), -->
<!--          perc = count_redacted/total) -->

<!-- tot_obs <- max(weekly_sgtf_counts_perc$total, na.rm = T) -->

<!-- weekly_sgtf_counts_perc %>% -->
<!--   ggplot(aes(x = week, y = count_redacted, fill = sgtf_alltests)) + -->
<!--   geom_bar(stat='identity') + -->
<!--   geom_line(data = (weekly_sgtf_counts_perc %>% filter(sgtf_alltests == "Cases with SGTF")), mapping = aes(y = perc*tot_obs), color = "red") + -->
<!--   scale_y_continuous(labels = comma, -->
<!--                      sec.axis = sec_axis( ~./tot_obs,  -->
<!--                                           labels = percent,  -->
<!--                                           name = "Percent")) + -->
<!--   theme_bw() + -->
<!--   scale_x_date(date_breaks = "2 month", date_labels =  "%d %b %Y") + -->
<!--   labs(x = "Test date (week commencing)", y = "Count", title = "(a)") + -->
<!--   theme( -->
<!--     legend.position = "bottom",  -->
<!--     legend.title = element_blank(), -->
<!--     axis.text = element_text(size = 10), -->
<!--     axis.text.x = element_text(angle = 60, hjust = 1), -->
<!--     axis.title = element_text(size = 10), -->
<!--     axis.line.x = element_line(colour = "black"), -->
<!--     panel.grid.minor.x = element_blank()) +  -->
<!--   scale_fill_brewer(palette = "Blues") -->

<!-- # SGTF plot by region -->
<!-- weekly_sgtf_counts_by_region_perc <- weekly_sgtf_counts_by_region %>% -->
<!--   filter(sgtf_alltests %in% c("Cases with SGTF", "Detectable S-gene")) %>% -->
<!--   group_by(week, region_nhs) %>% -->
<!--   mutate(total = sum(count_redacted, na.rm = T), -->
<!--          perc = count_redacted/total) -->

<!-- tot_obs <- max(weekly_sgtf_counts_by_region_perc$total, na.rm = T) -->

<!-- weekly_sgtf_counts_by_region_perc %>% -->
<!--   filter(!is.na(region_nhs)) %>% -->
<!--   ggplot(aes(x = week, y = count_redacted, fill = sgtf_alltests)) + -->
<!--   geom_bar(stat='identity') + -->
<!--   geom_line(data = (weekly_sgtf_counts_by_region_perc %>% filter(sgtf_alltests == "Cases with SGTF")), aes(y = perc*tot_obs), color = "red") + -->
<!--   facet_wrap(~region_nhs) + -->
<!--   scale_y_continuous(labels = comma, -->
<!--                      sec.axis = sec_axis(~./tot_obs,  -->
<!--                                          labels = percent, -->
<!--                                          name = "Percent")) + -->
<!--   theme_bw() + -->
<!--   scale_x_date(date_breaks = "2 month", date_labels =  "%d %b %Y") + -->
<!--   labs(x = "Test date (week commencing)", y = "Count", title = "(b)") + -->
<!--   theme( -->
<!--     legend.position = "bottom",  -->
<!--     legend.title = element_blank(), -->
<!--     axis.text = element_text(size = 10), -->
<!--     axis.text.x = element_text(angle = 60, hjust = 1), -->
<!--     axis.title = element_text(size = 10), -->
<!--     axis.line.x = element_line(colour = "black"), -->
<!--     panel.grid.minor.x = element_blank()) +  -->
<!--   scale_fill_brewer(palette = "Blues") -->

<!-- ``` -->

<!-- **Table 1 Number and proportion of COVID-19 cases among those with S gene detection results, by age group and sex.** Counts <8 have been redacted and counts >7 are rounded to the nearest 10; as a result percentages may not add up to 100%. -->
<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%'} -->

<!-- sgtf_counts_age_sex <- read_rds(here::here("output", "data", "weekly_sgtf_counts_by_age_sex.rds")) -->

<!-- males <- sgtf_counts_age_sex %>% -->
<!--   filter(!is.na(ageband), -->
<!--          sex == "M", -->
<!--          sgtf_alltests %in% c("Cases with SGTF", "Detectable S-gene")) %>% -->
<!--   pivot_wider( -->
<!--     id_cols = ageband, -->
<!--     names_from = sgtf_alltests, -->
<!--     values_from = count_redacted)%>% -->
<!--   mutate(Total = `Cases with SGTF` + `Detectable S-gene`, -->
<!--          `Percent SGTF` = round(`Cases with SGTF`/Total*100, digits = 0)) %>% -->
<!--   select(ageband, Total, `Cases with SGTF`, `Percent SGTF`) -->

<!-- females <- sgtf_counts_age_sex %>% -->
<!--   filter(!is.na(ageband), -->
<!--          sex == "F", -->
<!--          sgtf_alltests %in% c("Cases with SGTF", "Detectable S-gene")) %>% -->
<!--   pivot_wider( -->
<!--     id_cols = ageband, -->
<!--     names_from = sgtf_alltests, -->
<!--     values_from = count_redacted)%>% -->
<!--   mutate(Total = `Cases with SGTF` + `Detectable S-gene`, -->
<!--          `Percent SGTF` = round(`Cases with SGTF`/Total*100, digits = 0)) %>% -->
<!--   select(ageband, Total, `Cases with SGTF`, `Percent SGTF`) -->

<!-- all <- full_join(males, females, by = c("ageband")) %>% -->
<!--   mutate(Total = `Total.x` + `Total.y`, -->
<!--          `Cases with SGTF` = `Cases with SGTF.x` + `Cases with SGTF.y`, -->
<!--          `Percent SGTF` = round(`Cases with SGTF`/Total*100, digits = 0)) -->

<!-- table <- all %>% -->
<!--   ungroup() %>% -->
<!--   add_row(ageband = "Total", -->
<!--           Total.x = sum(all$Total.x, na.rm = T), -->
<!--           `Cases with SGTF.x` = sum(all$`Cases with SGTF.x`, na.rm = T), -->
<!--           `Percent SGTF.x` = NA, -->
<!--           Total.y = sum(all$Total.y, na.rm = T), -->
<!--           `Cases with SGTF.y` = sum(all$`Cases with SGTF.y`, na.rm = T), -->
<!--           `Percent SGTF.y` = NA, -->
<!--           Total = sum(all$Total, na.rm = T), -->
<!--           `Cases with SGTF` = sum(all$`Cases with SGTF`), -->
<!--           `Percent SGTF` = NA) %>% -->
<!--   mutate(`Percent SGTF.x` = round(`Cases with SGTF.x`/Total.x*100, digits = 0), -->
<!--          `Percent SGTF.y` = round(`Cases with SGTF.y`/Total.y*100, digits = 0), -->
<!--          `Percent SGTF` = round(`Cases with SGTF`/Total*100, digits = 0)) -->

<!-- colnames(table) <- c("Age group", "Total", "Cases with SGTF", "Percent SGTF", -->
<!--                      "Total", "Cases with SGTF", "Percent SGTF", -->
<!--                      "Total", "Cases with SGTF", "Percent SGTF") -->

<!-- table %>% -->
<!--   kable(row.names = FALSE,  -->
<!--         align = c("l", rep("c", 9)), -->
<!--         booktabs=TRUE) %>% -->
<!--   kable_styling(position = "center", full_width = F, bootstrap_options = "striped", font_size = 13)  %>% -->
<!--   add_header_above(., c(" ", "Male" = 3, "Female" = 3, "All" = 3)) -->

<!-- ``` -->
