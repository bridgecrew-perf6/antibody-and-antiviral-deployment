---
title: Coverage and uptake of neutralising monoclonal antibodies or antivirals for non-hospitalised patients with COVID-19
output:
  html_document:
  theme: journal
github_document:
  keep_html: TRUE
# output:
#   pdf_document
---
  
```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}
pre[class] {
  max-height: 200px;
}
```

<style>
  body {
    text-align: justify;
     font-size: 11pt}
</style>

  
$$\\[0.25cm]$$
```{r setup, include=FALSE}
# Document settings ----
knitr::opts_chunk$set(echo = TRUE)

# Import libraries ----
library(tidyverse)
library(here)
library(kableExtra)
library(knitr)
library(ggplot2)
library(png)
library(readr)
library(htmltools)
library(gt)
library(scales)

# Import custom user functions ----
source(here("analysis", "lib", "custom_functions.R"))

# Input directory ----
input_dir_os <- here("released_outputs", "reports", "coverage")
#input_dir_os <- here("output", "coverage")

# Output directory ----
output_dir_rmd <- here("reports", "coverage")
fs::dir_create(output_dir_rmd)

# Import data ----
report_stats <- read_csv(fs::path(input_dir_os, "table_report_stats_redacted.csv"))
flowchart_non_elig <- read_csv(fs::path(input_dir_os, "table_non_elig_flowchart_redacted.csv")) 

# End date ----
end_date <- report_stats$study_end
```

# Overview
This OpenSAFELY report was rapidly developed to support monitoring the ongoing roll-out of neutralising monoclonal antibodies (nMABs) and antivirals for treatment of COVID-19, based on the population of 23.4m people registered with practices that use TPP SystmOne software. This report will be updated approximately weekly as new data arrives. 

The code and data for this report can be found at the OpenSAFELY [antibody-and-antiviral-deployment repository](https://github.com/opensafely/antibody-and-antiviral-deployment). The accompanying manuscript will be available shortly on MedRXiV (link to follow) and submitted for peer review. 


##### Contents
* [Introduction](#intro)
* [Results](#results)
  + [Coverage of COVID-19 treatment](#coverage)
  + [Coverage of COVID-19 treatment by high risk cohorts](#hrc)
  + [Key demographic and clinical characteristics of treated patients](#demographic)
  + [Concordance with guidance](#concordance)
  + [Time to treatment](#time)
* [Methods](#methods)

      
# Introduction <a name="intro"></a>
While vaccines remain the best strategy to prevent COVID-19, recent evidence suggests neutralising monoclonal antibodies (nMABs) or antivirals could potentially benefit certain vulnerable populations before or after exposure to SARS-CoV-2, such as the unvaccinated or recently vaccinated high-risk patients. 

With the recent roll-out of nMABs and antivirals, there is an urgent need to for knowledge and understanding around the use of these treatments in patients with COVID-19, such as factors of relevance in determining nMAB and antiviral treatment and the impact of nMAB and antiviral treatment in the community and hospital settings.

Full methods in code form can be found in the accompanying [antibody-and-antiviral-deployment repository](https://github.com/opensafely/antibody-and-antiviral-deployment) and are also described in our paper, linked above. [Brief methods](#methods) can be found at the end of the this report.  


      
      
# Results <a name="results"></a>
      
## Overall coverage of COVID-19 treatment <a name="coverage"></a>
Between **`r format(report_stats$study_start, format = "%d-%b-%Y")`** and **`r format(report_stats$study_end, format = "%d-%b-%Y")`**, a total of `r format(report_stats$eligible_patients, big.mark = ",", scientific = FALSE)` non-hospitalised patients registered at a TPP practice in England were identified as being eligible for receiving an antiviral or nMABs for treating COVID-19 (Figure 1). While the majority of these patients only belonged to one high risk cohort, `r format(report_stats$high_risk_cohort_2plus, big.mark = ",", scientific = FALSE)` (`r format(round(report_stats$high_risk_cohort_2plus/report_stats$eligible_patients*100, digits = 0), big.mark = ",", scientific = FALSE)`%) eligible patients had records indicating that they fell into multiple high risk cohorts (high risk cohort count range `r report_stats$high_risk_cohort_lower` - `r report_stats$high_risk_cohort_upper`). Out of the `r format(report_stats$eligible_patients, big.mark = ",", scientific = FALSE)` eligible patients, a total of `r format(report_stats$treated_patients, big.mark = ",", scientific = FALSE)` patients received an antiviral or nMABs (Figures 2 and 3); 

- Paxlovid: `r format(report_stats$treated_paxlovid, big.mark = ",", scientific = FALSE)`;
- Sotrovimab: `r format(report_stats$treated_sotrovimab, big.mark = ",", scientific = FALSE)`;
- Remdesivir: `r format(report_stats$treated_remdesivir, big.mark = ",", scientific = FALSE)`;
- Molnupiravir: `r format(report_stats$treated_molnupiravir, big.mark = ",", scientific = FALSE)`; 
- Casirivimab: `r format(report_stats$treated_casirivimab, big.mark = ",", scientific = FALSE)`.

$$\\[0.5cm]$$
```{r, coverage plot, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '90%', fig.align = 'center', fig.cap = "Figure 1: Cumulative total of patients eligible for receiving an antiviral or nMABs for treating COVID-19 since 11th December 2021, stratified by high risk cohort. Patients are included as eligible on the date of their positive SARS-CoV-2 test. Note, eligible patients can appear in more than one high risk group and the overall number (pre 10th February 2022) in each group is likely to be an overestimation due to including patients where their SARS-CoV-2 infection is confirmed by a lateral flow or polymerase chain reaction test."}

coverage_plot_data <- read_csv(here::here(input_dir_os, "table_cum_eligiblity_redacted.csv")) %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immuosupression due to HIV or AIDS (CD4 <350 cells/mm3)", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_))

coverage_plot_data$high_risk_cohort = unlist(lapply(strwrap(coverage_plot_data$high_risk_cohort, width=30, simplify=FALSE), paste, 
                             collapse="\n"))

plot_order <- coverage_plot_data %>%
  group_by(high_risk_cohort) %>%
  mutate(order = max(cum_count_redacted, na.rm = T)) %>%
  arrange(desc(order)) %>%
  filter(cum_count_redacted == order) %>%
  select(high_risk_cohort, order) %>%
  distinct()

coverage_plot_data <- coverage_plot_data %>%
  mutate(high_risk_cohort = factor(high_risk_cohort, levels = plot_order$high_risk_cohort))

coverage_plot <- coverage_plot_data %>%
  filter(elig_start <= end_date) %>%
  ggplot(aes(x = elig_start, y = cum_count_redacted, colour = high_risk_cohort, group = high_risk_cohort)) +
  geom_step(size = 1) +
  theme_classic(base_size = 8) +
  scale_x_date(date_breaks = "2 week", date_labels =  "%d %b %Y") +
  #facet_wrap(~high_risk_cohort, scales = "free_y", labeller = labeller(groupwrap = label_wrap_gen(10))) +
  labs(
    x = "Positive SARS-CoV-2 test date",
    y = "Number of patients eligible for receiving treatment",
    colour = "High risk cohort",
    title = "")  +
  theme(legend.position = "none") +
  theme(
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 12),
    legend.title=element_text(size=12, face = "bold"),
    legend.position = c(0.15,0.65),
    legend.background = element_rect(colour = "white"),
    legend.box.background = element_rect(colour = "black"),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank(),
    legend.box.margin = margin(t = 1, l = 1, b = 1, r = 1)) + 
  scale_y_continuous(labels = comma)

ggsave(
  here::here(output_dir_rmd, "figures", "figure_cum_eligiblity.png"),
  coverage_plot,
  units = "cm", width = 35, height = 20
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_cum_eligiblity.png"))

```

$$\\[0.5cm]$$
```{r, elig treatment type plot, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '90%', fig.align = 'center', fig.cap = "Figure 2: Cumulative total of patients who received an antiviral or nMAB for treating COVID-19 since 11th December 2021, stratified by treatment type"}

treatment_plot_data <- read_csv(here::here(input_dir_os, "table_cum_treatment_type_redacted.csv")) %>%
  filter(!is.na(treatment_date),
         treatment_date <= end_date,
         cum_count_redacted > 0) 

plot_order <- treatment_plot_data %>%
  group_by(treatment_type) %>%
  mutate(order = max(cum_count_redacted, na.rm = T)) %>%
  arrange(desc(order)) %>%
  filter(cum_count_redacted == order) %>%
  select(treatment_type, order) %>%
  distinct()

treatment_plot_data <- treatment_plot_data %>%
  mutate(treatment_type = factor(treatment_type, levels = plot_order$treatment_type))

treatment_type_plot <- treatment_plot_data %>%
  ggplot(aes(x = treatment_date, y = cum_count_redacted, colour = treatment_type, group = treatment_type)) +
  geom_step(size = 1) +
  theme_classic(base_size = 8) +
  scale_x_date(date_breaks = "1 week", date_labels =  "%d %b %Y") +
  labs(
    x = "Treatment date",
    y = "Number of patients receiving treatment",
    colour = "Treatment type",
    title = "") +
  theme(
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 12),
    legend.title=element_text(size=12, face = "bold"),
    legend.position = c(0.1,0.75),
    legend.background = element_rect(colour = "white"),
    legend.box.background = element_rect(colour = "black"),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank(),
    legend.box.margin = margin(t = 1, l = 1, b = 1, r = 1))

ggsave(
  here::here(output_dir_rmd, "figures", "figure_cum_treatment_type.png"),
  treatment_type_plot,
  units = "cm", width = 35, height = 20
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_cum_treatment_type.png"))

```



## Coverage of COVID-19 treatment by high risk cohort <a name="hrc"></a>
```{r, elig treatment plot, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '90%', fig.align = 'center', fig.cap = "Figure 3: Cumulative total of patients who received an antiviral or nMABs for treating COVID-19 since 11th December 2021, stratified by high risk cohorts. Note, treated patients can appear in more than one high risk group."}

treatment_plot_data_therapeutics <- read_csv(here::here(input_dir_os, "table_cum_treatment_redacted.csv")) %>%
  filter(!is.na(treatment_date),
         treatment_date <= end_date) %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immuosupression due to HIV or AIDS (CD4 <350 cells/mm3)", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_))

plot_order <- treatment_plot_data_therapeutics %>%
  group_by(high_risk_cohort) %>%
  mutate(order = max(cum_count_redacted, na.rm = T)) %>%
  arrange(desc(order)) %>%
  filter(cum_count_redacted == order) %>%
  select(high_risk_cohort, order) %>%
  distinct()

treatment_plot_data_therapeutics <- treatment_plot_data_therapeutics %>%
  mutate(high_risk_cohort = factor(high_risk_cohort, levels = plot_order$high_risk_cohort)) 

treatment_plot_therapeutics <- treatment_plot_data_therapeutics %>%
  ggplot(aes(x = treatment_date, y = cum_count_redacted, colour = high_risk_cohort, group = high_risk_cohort)) +
  geom_step(size = 1) +
  theme_classic(base_size = 8) +
  scale_x_date(date_breaks = "1 week", date_labels =  "%d %b %Y") +
  labs(
    x = "Treatment date",
    y = "Number of patients receiving treatment",
    colour = "High risk cohort",
    title = "") +
  theme(
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 12),
    legend.title=element_text(size=12, face = "bold"),
    legend.position = c(0.2,0.75),
    legend.background = element_rect(colour = "white"),
    legend.box.background = element_rect(colour = "black"),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank(),
    legend.box.margin = margin(t = 1, l = 1, b = 1, r = 1))

ggsave(
  here::here(output_dir_rmd, "figures", "figure_cum_treatment_therapeutics.png"),
  treatment_plot_therapeutics,
  units = "cm", width = 35, height = 20
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_cum_treatment_therapeutics.png"))

```

$$\\[0.5cm]$$
```{r, prop treatment plot, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%', fig.align = 'center', fig.cap = "Figure 4: Weekly proportion of eligible patients receiving an antiviral or nMAB for treating COVID-19 since 11th December 2021, stratified by high risk cohort"}

weekly_treatment_proportion <- read_csv(here::here(input_dir_os, "table_prop_treated_redacted.csv")) %>%
  filter(!is.na(prop_redacted),
         treatment_type == "All") %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immuosupression due to HIV or AIDS (CD4 <350 cells/mm3)", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_),
    
    high_risk_cohort = unlist(lapply(strwrap(high_risk_cohort, width=30, simplify=FALSE), paste, 
                                     collapse="\n"))) %>%
  mutate(treatment_type = case_when(
    treatment_type == "All" ~ "All", 
    treatment_type == "Paxlovid" ~ "Paxlovid", 
    treatment_type == "Sotrovimab" ~ "Sotrovimab", 
    treatment_type == "Remdesivir" ~ "Remdesivir", 
    treatment_type == "Molnupiravir" ~ "Molnupiravir", 
    treatment_type == "Casirivimab" ~ "Casirivimab", 
    TRUE ~ NA_character_))

plot_order <- weekly_treatment_proportion %>%
  group_by(high_risk_cohort) %>%
  mutate(order = max(prop_redacted, na.rm = T)) %>%
  arrange(desc(order)) %>%
  filter(prop_redacted == order) %>%
  select(high_risk_cohort, order) %>%
  distinct()

weekly_treatment_proportion <- weekly_treatment_proportion %>%
  mutate(high_risk_cohort = factor(high_risk_cohort, levels = plot_order$high_risk_cohort)) 

weekly_treatment_proportion_plot <- weekly_treatment_proportion %>%
  mutate(treatment_type = factor(treatment_type, levels = c("All", "Paxlovid", "Sotrovimab", "Remdesivir", 
                                                            "Molnupiravir", "Casirivimab"))) %>%
  ggplot(aes(x = elig_start, y = prop_redacted, colour = high_risk_cohort, group = high_risk_cohort)) +
  geom_line(size = 1) +
  facet_wrap(~high_risk_cohort, scales = "free_y") +
  theme_classic(base_size = 8) +
  scale_x_date(date_breaks = "2 week", date_labels =  "%d %b %Y") +
  labs(
    x = "",
    y = "Proportion of eligble patients receiving treatment",
    colour = "Treatment type",
    title = "") +
    theme(legend.position = "none") +
  theme(
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 12),
    legend.title=element_text(size=12, face = "bold"),
    strip.text = element_text(size=12))

ggsave(
  here::here(output_dir_rmd, "figures", "figure_prop_treatment.png"),
  weekly_treatment_proportion_plot,
  units = "cm", width = 35, height = 20
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_prop_treatment.png"))
```

$$\\[0.5cm]$$
```{r, eligible-treatment breakdown, echo=FALSE, message=FALSE, warning=FALSE, out.width = '90%'}

table_elig_treat_redacted <- read_csv(fs::path(input_dir_os, "table_elig_treat_redacted.csv")) %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immuosupression due to HIV or AIDS (CD4 <350 cells/mm3)", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_)) %>%
  mutate(order = Treated/Eligibile,
        order = ifelse(high_risk_cohort == "All", 1, order)) %>%
  arrange(desc(order)) %>%
  select(-order)

table_elig_treat_redacted <- table_elig_treat_redacted %>%
  mutate(Treated_perc = paste(round(Treated/Eligibile*100, digits = 0), " (",
                              round((Treated/Eligibile - 1.96*sqrt((Treated/Eligibile)*(1-Treated/Eligibile)/Eligibile))*100, digits = 0),
                              "-",
                              round((Treated/Eligibile + 1.96*sqrt((Treated/Eligibile)*(1-Treated/Eligibile)/Eligibile))*100, digits = 0), 
                              ")",
                              sep = ""),
         Paxlovid_perc = paste(round(Paxlovid/Treated*100, digits = 0), " (",
                              round((Paxlovid/Treated - 1.96*sqrt((Paxlovid/Treated)*(1-Paxlovid/Treated)/Treated))*100, digits = 0),
                              "-",
                              round((Paxlovid/Treated + 1.96*sqrt((Paxlovid/Treated)*(1-Paxlovid/Treated)/Treated))*100, digits = 0), 
                              ")",
                              sep = ""),
         Sotrovimab_perc = paste(round(Sotrovimab/Treated*100, digits = 0), " (",
                              round((Sotrovimab/Treated - 1.96*sqrt((Sotrovimab/Treated)*(1-Sotrovimab/Treated)/Treated))*100, 
                                    digits = 0),
                              "-",
                              round((Sotrovimab/Treated + 1.96*sqrt((Sotrovimab/Treated)*(1-Sotrovimab/Treated)/Treated))*100, 
                                    digits = 0), 
                              ")",
                              sep = ""),
         Remdesivir_perc = paste(round(Remdesivir/Treated*100, digits = 0), " (",
                              round((Remdesivir/Treated - 1.96*sqrt((Remdesivir/Treated)*(1-Remdesivir/Treated)/Treated))*100, 
                                    digits = 0),
                              "-",
                              round((Remdesivir/Treated + 1.96*sqrt((Remdesivir/Treated)*(1-Remdesivir/Treated)/Treated))*100, 
                                    digits = 0), 
                              ")",
                              sep = ""),
         Molnupiravir_perc = paste(round(Molnupiravir/Treated*100, digits = 0), " (",
                              round((Molnupiravir/Treated - 1.96*sqrt((Molnupiravir/Treated)*(1-Molnupiravir/Treated)/Treated))*100,
                                    digits = 0),
                              "-",
                              round((Molnupiravir/Treated + 1.96*sqrt((Molnupiravir/Treated)*(1-Molnupiravir/Treated)/Treated))*100, 
                                    digits = 0), 
                              ")",
                              sep = ""),
         Casirivimab_perc = paste(round(Casirivimab/Treated*100, digits = 0), " (",
                              round((Casirivimab/Treated - 1.96*sqrt((Casirivimab/Treated)*(1-Casirivimab/Treated)/Treated))*100, 
                                    digits = 0),
                              "-",
                              round((Casirivimab/Treated + 1.96*sqrt((Casirivimab/Treated)*(1-Casirivimab/Treated)/Treated))*100, 
                                    digits = 0), 
                              ")",
                              sep = "")) %>%
  select(high_risk_cohort, Eligibile, Treated, Treated_perc, Paxlovid, Paxlovid_perc, Sotrovimab, Sotrovimab_perc, Remdesivir, 
         Remdesivir_perc, Molnupiravir, Molnupiravir_perc, Casirivimab, Casirivimab_perc) %>%  
  mutate(Paxlovid = ifelse(is.na(Paxlovid), "<5", Paxlovid),
         Paxlovid_perc = ifelse(Paxlovid_perc == "NA (NA-NA)", "--", Paxlovid_perc),
         Remdesivir = ifelse(is.na(Remdesivir), "<5", Remdesivir),
         Remdesivir_perc = ifelse(Remdesivir_perc == "NA (NA-NA)", "--", Remdesivir_perc),
         Casirivimab = ifelse(is.na(Casirivimab), "<5", Casirivimab),
         Casirivimab_perc = ifelse(Casirivimab_perc == "NA (NA-NA)", "--", Casirivimab_perc))
         
colnames(table_elig_treat_redacted) <- c("High risk cohort", "Count", "Count", "%", "Count", "%", 
                                         "Count", "%", "Count", "%", "Count", "%", 
                                         "Count", "%")

table_elig_treat_redacted %>%
  kable(caption = "Table 1: Count and proportion of eligible patients who have received treatment for COVID-19 since 11th December 2021, broken down by high risk cohort and treatment type", 
        row.names = FALSE, 
        align = c("l", rep("c", 13)),
        booktabs=TRUE) %>%
  kable_styling(position = "center", full_width = T, bootstrap_options = "striped", font_size = 13)  %>%
  #row_spec(1, bold = T) %>%
  column_spec(1, bold = T, width = "10em") %>%
  column_spec(2, width = "5em") %>%
  column_spec(4, background = "lightgrey")  %>%
  add_header_above(., c(" ", "Eligible", "All" = 2, "Paxlovid  " = 2, "Sotrovimab" = 2, "Remdesivir" = 2,
                        "Molnupiravir" = 2, "Casirivimab" = 2)) %>%
  add_header_above(., c(" ", "", "Treated" = 12)) %>%
  add_footnote(c("High risk cohorts are arranged in descending order, according to percentage treated",
                 "All percentages (%) are caluclated with 95% confidence intervals"), 
               notation = "symbol")

write_csv(table_elig_treat_redacted, here::here(output_dir_rmd, "tables", "table_prop_eligible_high_risk_cohort.csv"))

```


## Key demographic and clinical characteristics of treated patients <a name="demographic"></a>
```{r, echo=FALSE, warning=FALSE, message=FALSE, out.width = '90%'}

table_demo_clinc_breakdown_redacted <- read_csv(fs::path(input_dir_os, "table_demo_clinc_breakdown_redacted.csv")) %>%
  mutate(Group = factor(Group, 
                        levels = c("ageband", "sex", "ethnicity", "imd", "rural_urban", "region_nhs", "autism_nhsd", "care_home_primis",
                                   "dementia_nhsd", "learning_disability_primis", "serious_mental_illness_nhsd", 
                                   "housebound_opensafely", "shielded_primis", "sickle_cell_disease_nhsd", "vaccination_status"),
                        labels = c("Age band", "Sex", "Ethnicity", "IMD", "Rurality", "Region", "Autism", "Care home", "Dementia",
                                   "Learning disability ", "Serious mental illness", "Housebound", "CEV", "Sickle cell disease",
                                   "Vaccination status")),
         Variable = factor(Variable, 
                           levels = c("12-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+", 
                                      "Female", "Male" ,
                                      "White", "Asian or Asian British", "Black or Black British", "Mixed", "Other ethnic groups",
                                      "1 most deprived", "2", "3", "4", "5 least deprived",
                                      "Urban - conurbation" , "Urban - city and town", "Rural - town and fringe", 
                                      "Rural - village and dispersed",
                                      "East Midlands", "East of England", "London", "North East", "North West", "South East",
                                      "South West", "West Midlands", "Yorkshire and the Humber",
                                      "autism_nhsd", "care_home_primis",
                                      "dementia_nhsd", "learning_disability_primis", "serious_mental_illness_nhsd", 
                                      "housebound_opensafely", "shielded_primis", "sickle_cell_disease_nhsd",
                                      "Un-vaccinated (declined)", "Un-vaccinated" , "One vaccination", "Two vaccinations", 
                                      "Three or more vaccinations", "Unknown"),
                           labels = c("12-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+", 
                                      "Female", "Male" ,
                                      "White", "Asian or Asian British", "Black or Black British", "Mixed", "Other ethnic groups",
                                      "1 most deprived", "2", "3", "4", "5 least deprived",
                                      "Urban - conurbation" , "Urban - city and town", "Rural - town and fringe", 
                                      "Rural - village and dispersed",
                                      "East Midlands", "East of England", "London", "North East", "North West", "South East",
                                      "South West", "West Midlands", "Yorkshire and the Humber",
                                      "Autism", "Care home", "Dementia", "Learning disability ", "Serious mental illness",
                                      "Housebound", "CEV", "Sickle cell disease",
                                      "Un-vaccinated (declined)", "Un-vaccinated" , "One vaccination", "Two vaccinations", 
                                      "Three or more vaccinations", "Unknown")))  %>%
  arrange(Group, Variable) %>%
  filter(!is.na(Variable)) %>%
  rename(Eligibile = "All",  Remdesivir = "Remedesivir") %>%
  mutate(Treated_perc = paste(round(Treated/Eligibile*100, digits = 0), " (",
                              round((Treated/Eligibile - 1.96*sqrt((Treated/Eligibile)*(1-Treated/Eligibile)/Eligibile))*100, digits = 0),
                              "-",
                              round((Treated/Eligibile + 1.96*sqrt((Treated/Eligibile)*(1-Treated/Eligibile)/Eligibile))*100, digits = 0), 
                              ")",
                              sep = ""),
         Paxlovid_perc = paste(round(Paxlovid/Treated*100, digits = 0), " (",
                               round((Paxlovid/Treated - 1.96*sqrt((Paxlovid/Treated)*(1-Paxlovid/Treated)/Treated))*100, digits = 0),
                               "-",
                               round((Paxlovid/Treated + 1.96*sqrt((Paxlovid/Treated)*(1-Paxlovid/Treated)/Treated))*100, digits = 0),
                               ")",
                               sep = ""),
         Sotrovimab_perc = paste(round(Sotrovimab/Treated*100, digits = 0), " (",
                                 round((Sotrovimab/Treated - 1.96*sqrt((Sotrovimab/Treated)*(1-Sotrovimab/Treated)/Treated))*100, 
                                       digits = 0),
                                 "-",
                                 round((Sotrovimab/Treated + 1.96*sqrt((Sotrovimab/Treated)*(1-Sotrovimab/Treated)/Treated))*100, 
                                       digits = 0), 
                                 ")",
                                 sep = ""),
         Remdesivir_perc = paste(round(Remdesivir/Treated*100, digits = 0), " (",
                                 round((Remdesivir/Treated - 1.96*sqrt((Remdesivir/Treated)*(1-Remdesivir/Treated)/Treated))*100, 
                                       digits = 0),
                                 "-",
                                 round((Remdesivir/Treated + 1.96*sqrt((Remdesivir/Treated)*(1-Remdesivir/Treated)/Treated))*100, 
                                       digits = 0), 
                                 ")",
                                 sep = ""),
         Molnupiravir_perc = paste(round(Molnupiravir/Treated*100, digits = 0), " (",
                                   round((Molnupiravir/Treated-1.96*sqrt((Molnupiravir/Treated)*(1-Molnupiravir/Treated)/Treated))*100,
                                         digits = 0),
                                   "-",
                                   round((Molnupiravir/Treated + 1.96*sqrt((Molnupiravir/Treated)*(1-Molnupiravir/Treated)/Treated))*100,
                                         digits = 0), 
                                   ")",
                                   sep = ""),
         Casirivimab_perc = paste(round(Casirivimab/Treated*100, digits = 0), " (",
                                  round((Casirivimab/Treated - 1.96*sqrt((Casirivimab/Treated)*(1-Casirivimab/Treated)/Treated))*100, 
                                        digits = 0),
                                  "-",
                                  round((Casirivimab/Treated + 1.96*sqrt((Casirivimab/Treated)*(1-Casirivimab/Treated)/Treated))*100, 
                                        digits = 0), 
                                  ")",
                                  sep = "")) %>%
  select(Group, Variable, Eligibile, Treated, Treated_perc, Paxlovid, Paxlovid_perc, Sotrovimab, Sotrovimab_perc, Remdesivir, 
         Remdesivir_perc, Molnupiravir, Molnupiravir_perc, Casirivimab, Casirivimab_perc) %>%  
  mutate(Eligibile = ifelse(is.na(Eligibile), "<5", Eligibile),
         Treated = ifelse(is.na(Treated), "<5", Treated),
         Treated_perc = ifelse(Treated_perc == "NA (NA-NA)", "--", Treated_perc),
         Paxlovid = ifelse(is.na(Paxlovid), "<5", Paxlovid),
         Paxlovid_perc = ifelse(Paxlovid_perc == "NA (NA-NA)", "--", Paxlovid_perc),
         Sotrovimab = ifelse(is.na(Sotrovimab), "<5", Sotrovimab),
         Sotrovimab_perc = ifelse(Sotrovimab_perc == "NA (NA-NA)", "--", Sotrovimab_perc),
         Remdesivir = ifelse(is.na(Remdesivir), "<5", Remdesivir),
         Remdesivir_perc = ifelse(Remdesivir_perc == "NA (NA-NA)", "--", Remdesivir_perc),
         Molnupiravir = ifelse(is.na(Molnupiravir), "<5", Molnupiravir),
         Molnupiravir_perc = ifelse(Molnupiravir_perc == "NA (NA-NA)", "--", Molnupiravir_perc),
         Casirivimab = ifelse(is.na(Casirivimab), "<5", Casirivimab),
         Casirivimab_perc = ifelse(Casirivimab_perc == "NA (NA-NA)", "--", Casirivimab_perc))

colnames(table_demo_clinc_breakdown_redacted) <- c("Group", "Variable", "Count", "Count", "%", "Count", "%", 
                                                   "Count", "%", "Count", "%", "Count", "%", 
                                                   "Count", "%")
table_demo_clinc_breakdown_redacted %>%
  kable(caption = "Table 2: Count and proportion of eligible patients who have received treatment for COVID-19, broken down by demographic and clinical categories and by treatment type", 
        row.names = FALSE, 
        align = c("l", "l", rep("c", 11)),
        booktabs=TRUE) %>%
  kable_styling(position = "center", full_width = T, bootstrap_options = "striped", font_size = 13)  %>%
  column_spec(1, bold = T, width = "2em") %>%
  column_spec(2, bold = T, width = "2em") %>%
  column_spec(5, background = "lightgrey") %>%
  add_header_above(., c(" ", "", "Eligible", "All" = 2, "Paxlovid" = 2, "Sotrovimab" = 2, "Remdesivir" = 2,
                        "Molnupiravir" = 2, "Casirivimab" = 2)) %>%
  add_header_above(., c(" ", "", "", "Treated" = 12)) %>%
  add_footnote(c("All percentages (%) are caluclated with 95% confidence intervals"), 
               notation = "symbol")

write_csv(table_demo_clinc_breakdown_redacted, here::here(output_dir_rmd, "tables", "table_prop_eligible_clinc_demo.csv"))


```

## Concordance with guidance <a name="concordance"></a>
Of the `r format(report_stats$treated_patients, format = "%d-%b-%Y")` patients who received treatment for COVID-19 between `r format(report_stats$study_start, format = "%d-%b-%Y")` and `r format(report_stats$study_end, format = "%d-%b-%Y")`,  `r format(as.numeric(flowchart_non_elig[1,2]), big.mark = ",", scientific = FALSE)` patients were missing records needed to confirm eligibility. It is likely that most, if not all, of these patients meet all of the eligibility criteria and none of the exclusion criteria but, for example, their SARS-CoV-2 test result was not available in their record or we just do not have access to all the criteria the clinician might use to assess high risk group status (such as the patients identified via non-digital methods).

```{r non_elig, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, out.width = '80%', fig.align = 'center', fig.cap = "Figure 4: Breakdown of eligibility criteria variables in treated patients with missing records needed to confirm eligibility"}

flowchart_non_elig_plot <- flowchart_non_elig[-c(1,8),] %>%
  mutate(criteria2 = c("No positive SARS-CoV-2 test record", 
                       "Positive SARS-CoV-2 test record in previous 30 days",
                       "No high risk cohort identified within records",                      
                       "High risk cohort identified within records does not match high risk cohort associated with treatment",
                       "Required hospitalisation within 30 days prior to treatment with COVID-19 recorded as the primary diagnosis",
                       "Required hospitalisation within 30 days prior to treatment with any diagnosis",
                       "Non symptomatic positive SARS-CoV-2 test record",
                       "Treated with paxlovid outside of treatment eligibility window",           
                       "Treated with paxlovid and in renal or liver high risk cohort",
                       "Treated with paxlovid aged under 18",                       
                       "Treated with paxlovid and pregnant",
                       "Treated with sotrovimab outside of treatment eligibility window",
                       "Treated with sotrovimab aged under 12",  
                       "Treated with sotrovimab weight under 40kg", 
                       "Treated with remdesivir outside of treatment eligibility window",
                       "Treated with remdesivir aged under 12",  
                       "Treated with remdesivir weight under 40kg", 
                       "Treated with molnupiravir outside of treatment eligibility window",
                       "Treated with molnupiravir and pregnant")) %>%
  filter(n != 0) %>%
  mutate(n = as.numeric(ifelse(n == "<5", 5, n))) %>%
  filter(#criteria != "c_no_high_risk_group_match",
    #criteria != "c_no_high_risk_group_nhsd",
    criteria != "c_any_covid_hospital_admission_last_30_days") %>%
  #group_by(criteria3) %>%
  #summarise(n = sum(n)) %>%
  arrange(desc(n))

flowchart_non_elig_plot$criteria2 = unlist(lapply(strwrap(flowchart_non_elig_plot$criteria2, width=30, simplify=FALSE), paste, 
                                                  collapse="\n"))

flowchart_non_elig_plot <- flowchart_non_elig_plot %>%
  mutate(criteria2 = factor(criteria2, levels = unique(flowchart_non_elig_plot$criteria2)))

flowchart_non_elig_plot <- flowchart_non_elig_plot %>%
  ggplot() +
  geom_col(aes(x = criteria2, y = n, fill = criteria2)) + 
  theme_classic(base_size = 8) +
  labs(x = "",
       y = "Number of patients receiving treatment",
       colour = "",
       title = "") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        strip.text = element_text(size=12))

ggsave(
  here::here(output_dir_rmd, "figures", "figure_non_elig_breakdown.png"),
  flowchart_non_elig_plot,
  units = "cm", width = 40, height = 30
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_non_elig_breakdown.png"))

```


## Time to treatment <a name="time"></a>
```{r time to treatment, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, out.width = '80%', fig.align = 'center', fig.cap = "Figure 4a: Time between positive SARS-CoV-2 test and treatment for COVID-19, broken down by treatment type"}

data_time_between <- read_csv(fs::path(input_dir_os, "table_time_to_treat_redacted.csv"))

data_time_between_plot <- data_time_between %>%
  filter(high_risk_cohort == "All",
         !is.na(tb),
         !is.na(n),
         tb < 15) %>%
  ggplot(aes(tb)) +
  geom_col(aes(x = tb, y = n, fill = treatment_type, group = treatment_type), position = "dodge") + 
  theme_bw(base_size = 8) +
  facet_wrap(~treatment_type, ncol = 2) +
  theme(legend.position = "none") +
  labs(x = "Time between positive SARS-CoV-2 test and treatment for COVID-19 (days)",
       y = "Number of patients receiving treatment",
       colour = "High risk cohort",
       title = "") +
  theme(legend.position = "none",
        legend.title = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        strip.text = element_text(size=12))

ggsave(
  here::here(output_dir_rmd, "figures", "figure_time_to_treatment_types.png"),
  data_time_between_plot,
  units = "cm", width = 40, height = 30
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_time_to_treatment_types.png"))

```

$$\\[0.5cm]$$
```{r time to treatment 2, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, fig.height=8, out.width = '80%', fig.align = 'center', fig.cap = "Figure 4b: Time between positive SARS-CoV-2 test and treatment for COVID-19, broken down by high risk cohort"}

data_time_between <- read_csv(fs::path(input_dir_os, "table_time_to_treat_redacted.csv"))

time_groups <- data_time_between %>%
  filter(!is.na(high_risk_cohort),
         !is.na(n),
         tb < 15)  %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immuosupression due to HIV or AIDS (CD4 <350 cells/mm3)", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_)) %>%
  mutate(high_risk_cohort = unlist(lapply(strwrap(high_risk_cohort, width=30, simplify=FALSE), paste, collapse="\n"))) 

plot_order <- time_groups %>%
  group_by(high_risk_cohort) %>%
  mutate(order = max(n, na.rm = T)) %>%
  arrange(desc(order)) %>%
  filter(n == order) %>%
  select(high_risk_cohort, order) %>%
  distinct()

time_groups <- time_groups %>%
  mutate(high_risk_cohort = factor(high_risk_cohort, levels = plot_order$high_risk_cohort))

data_time_between_plot <- time_groups %>%
  arrange(high_risk_cohort, tb) %>%
  ggplot(aes(tb)) +
  geom_col(aes(x = tb, y = n, fill = high_risk_cohort, group = high_risk_cohort), position = "dodge") + 
  theme_bw(base_size = 8) +
  facet_wrap(~high_risk_cohort, scales = "free_y", ncol = 3) +
  theme(legend.position = "none") +
  labs(x = "Time between positive SARS-CoV-2 test and treatment for COVID-19 (days)",
       y = "Number of patients receiving treatment",
       colour = "High risk cohort",
       title = "") +
  theme(legend.position = "none",
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 20),
    strip.text = element_text(size=12)) +
  scale_y_continuous(labels = comma)

ggsave(
  here::here(output_dir_rmd, "figures", "figure_time_to_treatment_cohort.png"),
  data_time_between_plot,
  units = "cm", width = 40, height = 30
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_time_to_treatment_cohort.png"))

```

$$\\[0.5cm]$$


# Brief Methods <a name="methods"></a>

Full methods in code form can be found in the accompanying [antibody-and-antiviral-deployment repository](https://github.com/opensafely/antibody-and-antiviral-deployment) and are also described in our paper, linked above. Brief methods are given below.  

### Data sources
All data were analysed securely through OpenSAFELY-TPP  [https://opensafely.org](https://opensafely.org). Contains the full pseudonymised primary care records for all patients currently registered with general practices using TPP SystmOne software (approximately 23.4 million, 40% of the English population). Data are linked with accident and emergency (A&E) attendance and in-patient records from NHS Digital; national coronavirus testing records from the Second Generation Surveillance System (SGSS); and the “COVID-19 therapeutics dataset”, a patient-level dataset on antiviral and nMAB treatments from NHS England, derived from software used to notify NHS England of COVID-19 treatments.  

### Study population

Base population:
- Patients in OpenSAFELY-TPP registered with a general practice on 11th December 2021 (earliest possible date for eligibility for receiving antivirals/nMABS in outpatient settings).Patients with unknown date of birth excluded. 

Eligible patients:
- Eligibility and exclusion criteria were applied as per the Interim Clinical Commissioning Policy for non-hospitalised COVID-19 patients (NHSE, 28/01/2022): symptomatic SARS-CoV-2 infection not requiring hospitalisation or supplemental oxygen, in a ‘high risk’ cohort, no known hypersensitivity reaction to relevant active substances). 
- To determine high risk status we applied the detailed codelists and logic from NHS Digital as far as possible.
- We also included patients in the eligible population if they were in the Treated cohort below.

Treated patients:
- Treatments and the date they were given were identified in the COVID-19 therapeutics dataset, restricted to those treated in the community (“non_hospitalised”).
- Patients issued more than one treatment within two weeks of one another, or with an implausible treatment date (e.g. far in the future) were excluded. 

### Key demographic and clinical characteristics
We classified patients by age group, sex, NHS region of their general practice and other key demographics including ethnicity (White, Black, Asian or Asian British, Mixed, Other, and Unknown), and Index of Multiple Deprivation (IMD, in quintiles, derived from patient postcode at lower super output area level). Individuals with missing sex, ethnicity, IMD or region were included as “Unknown”. Treated patients were also grouped by whether they had autism, dementia, learning disability, serious mental illness, were resident in a care home or housebound, and by vaccination status.

### Concordance with guidance
For patients who received treatment but who were not otherwise identified in the eligible population, we report which eligibility or exclusion criteria were not met (e.g. no positive SARS-CoV-2 test result). Where possible within available data, we also report other potential breaches in guidance for patients receiving treatment, such as not being treated within the prescribed timescale (see Table S2 in the supplementary material for implementation details). 

### Descriptive statistics
Charts of eligibility and treatment coverage were generated for all high risk cohorts, and stratified by treatment type. Charts showing the weekly proportion of eligible people receiving each treatment were also generated, again stratified by treatment type. Simple descriptive statistics were also used to summarise the counts and proportions of eligible patients treated, stratified by high risk cohort, treatment type and by selected clinical and demographic group. Charts and results not presented in this report are available online for inspection in the associated Github [antibody-and-antiviral-deployment](https://github.com/opensafely/antibody-and-antiviral-deployment) repository. Patient counts are rounded to the nearest 10 to protect against small number differences in our routinely updating data. 

### Codelists
Detailed information on compilation and sources for every individual codelist are available at https://www.opencodelists.org/.


