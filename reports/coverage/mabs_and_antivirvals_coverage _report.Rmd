---
title: Coverage and uptake of neutralising monoclonal antibodies or antivirals for non-hospitalised patients with COVID-19
output:
  html_document:
  theme: journal
github_document:
  keep_html: TRUE
---
  
```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}
pre[class] {
  max-height: 200px;
}
```

<style>
  body {
    text-align: justify;
     font-size: 11pt}
</style>

  
$$\\[0.25cm]$$
```{r setup, include=FALSE}
# Document settings ----
knitr::opts_chunk$set(echo = TRUE)

# Import libraries ----
library(tidyverse)
library(here)
library(kableExtra)
library(knitr)
library(ggplot2)
library(png)
library(readr)
library(htmltools)
library(gt)
library(scales)

# Import custom user functions ----
source(here("analysis", "lib", "custom_functions.R"))

# Input directory ----
input_dir_os <- here("released_outputs", "reports", "coverage")
#input_dir_os <- here("output", "reports", "coverage")

# Output directory ----
output_dir_rmd <- here("reports", "coverage")
fs::dir_create(output_dir_rmd)

# Import data ----
report_stats <- read_csv(fs::path(input_dir_os, "table_report_stats_redacted.csv"))
flowchart_non_elig <- read_csv(fs::path(input_dir_os, "table_non_elig_flowchart_redacted.csv")) 
```

# Overview
While vaccines remain the best strategy to prevent COVID-19, recent evidence suggests monoclonal antibodies (nMABs) or antivirals could potentially benefit certain vulnerable populations before or after exposure to SARS-CoV-2, such as the unvaccinated or recently vaccinated high-risk patients. 

With the recent roll out of nMABs and antivirals, there is an urgent need to for knowledge and understanding around the use of nMABs and antivirals in the treatment of patients with COVID-19, such as factors of relevance in determining nMAB and antiviral treatment and the impact of nMAB and antiviral treatment in the community and hospital settings.

This OpenSAFELY report ...

The code and data for this report can be found at the OpenSafely [antibody-and-antiviral-deployment repository](https://github.com/opensafely/antibody-and-antiviral-deployment).


##### Contents
* [Introduction](#intro)
* [Methods](#methods)
* [Results](#results)
  + [Coverage of COVID-19 treatment](#coverage)
  + [Delivery of nMAB and antiviral treatment](#delivery)
  + [Key demographic and clinical characteristics of treated patients](#demographic)
  + [Concordance with guidance](#concordance)
  + [Assessment of high risk patient cohorting](#cohorting)
  + [Time to treatment](#time)
  + [COVID-19-related events](#events)


      
# Introduction <a name="intro"></a>
    
    
      
# Methods <a name="methods"></a>
      
      
# Results <a name="results"></a>
      
## Coverage of COVID-19 treatment <a name="coverage"></a>
Between `r format(report_stats$study_start, format = "%d-%b-%Y")` and `r format(report_stats$study_end, format = "%d-%b-%Y")`, a total of `r format(report_stats$eligible_patients, big.mark = ",", scientific = FALSE)` patients registered at a TPP practice in England were eligible for receiving a nMABs or antiviral for treating COVID-19 (Figure 1). Of these patients, a total of `r format(report_stats$eligible_treated_patients, big.mark = ",", scientific = FALSE)` patients had received treatment for COVID-19 within the same time period (Figure 2); `r format(report_stats$eligible_sotrovimab, big.mark = ",", scientific = FALSE)` received Sotrovimab, `r format(report_stats$eligible_molnupiravir, big.mark = ",", scientific = FALSE)` received Molnupiravir and `r format(report_stats$eligible_casirivimab, big.mark = ",", scientific = FALSE)` received Casirivimab.

Note, where appropriate, patients have been included within each relevant high risk cohorts. Out of the `r format(report_stats$eligible_patients, big.mark = ",", scientific = FALSE)` eligible patients, `r format(report_stats$high_risk_cohort_2plus, big.mark = ",", scientific = FALSE)` (`r format(round(report_stats$high_risk_cohort_2plus/report_stats$eligible_patients*100, digits = 2), big.mark = ",", scientific = FALSE)`%) were included in two or more high risk cohorts (range `r report_stats$high_risk_cohort_lower` - `r report_stats$high_risk_cohort_upper`). 

$$\\[0.5cm]$$
```{r, coverage plot, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '90%', fig.align = 'center', fig.cap = "Figure 1: Cumulative total of patients eligible for receiving a nMABs or antiviral for treating COVID-19 since 20th December 2021, stratified by high risk cohort. Note, eligible patients can appear in more than one high risk group and the overall number in each group is likely to be an overestimation due to including patients where their SARS-CoV-2 infection is confirmed by a lateral flow or polymerase chain reaction test."}
coverage_plot_data <- read_csv(here::here(input_dir_os, "table_cum_eligiblity_redacted.csv")) %>%
  filter(!(high_risk_group_elig %in% c("stem cell transplant recipients", "haematologic malignancy", "haematological diseases")),
         !is.na(high_risk_group_elig)) 

plot_order <- coverage_plot_data %>%
  group_by(high_risk_group_elig) %>%
  mutate(order = max(cum_count_redacted, na.rm = T)) %>%
  arrange(desc(order)) %>%
  filter(cum_count_redacted == order) %>%
  select(high_risk_group_elig, order) %>%
  distinct()

coverage_plot_data <- coverage_plot_data %>%
  mutate(high_risk_group_elig = factor(high_risk_group_elig, levels = plot_order$high_risk_group_elig))

coverage_plot <- coverage_plot_data %>%
  ggplot(aes(x = elig_start, y = cum_count_redacted, colour = high_risk_group_elig, group = high_risk_group_elig)) +
  geom_step(size = 1) +
  theme_classic(base_size = 8) +
  scale_x_date(date_breaks = "1 week", date_labels =  "%d %b %Y") +
  facet_wrap(~high_risk_group_elig, scales = "free_y") +
  labs(
    x = "Date",
    y = "Number of patients eligible for receiving treatment",
    colour = "High risk cohort",
    title = "")  +
  theme(legend.position = "none") +
  theme(
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 10)) +
  scale_y_continuous(labels = comma)

ggsave(
  here::here(output_dir_rmd, "figures", "figure_cum_eligiblity.png"),
  coverage_plot,
  units = "cm", width = 35, height = 20
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_cum_eligiblity.png"))

```

$$\\[0.5cm]$$

```{r, elig treatment plot, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '90%', fig.align = 'center', fig.cap = "Figure 2: Cumulative total of eligible patients who received a nMABs or antiviral for treating COVID-19 since 20th December 2021, stratified by high risk cohorts. Note, eligible treated patients can appear in more than one high risk group"}
treatment_plot_data_therapeutics <- read_csv(here::here(input_dir_os, "table_cum_treatment_redacted.csv")) %>%
  filter(!(high_risk_group_treated %in% c("stem cell transplant recipients", "haematologic malignancy", "haematological diseases", "other")),
         !is.na(high_risk_group_treated)) 

plot_order <- treatment_plot_data_therapeutics %>%
  group_by(high_risk_group_treated) %>%
  mutate(order = max(cum_count_redacted, na.rm = T)) %>%
  arrange(desc(order)) %>%
  filter(cum_count_redacted == order) %>%
  select(high_risk_group_treated, order) %>%
  distinct()

treatment_plot_data_therapeutics <- treatment_plot_data_therapeutics %>%
  mutate(high_risk_group_treated = factor(high_risk_group_treated, levels = plot_order$high_risk_group_treated)) 

treatment_plot_therapeutics <- treatment_plot_data_therapeutics %>%
  ggplot(aes(x = treatment_date, y = cum_count_redacted, colour = high_risk_group_treated, group = high_risk_group_treated)) +
  geom_step(size = 1) +
  theme_classic(base_size = 8) +
  scale_x_date(date_breaks = "1 week", date_labels =  "%d %b %Y") +
  labs(
    x = "Date",
    y = "Number of eligible patients receiving treatment",
    colour = "High risk cohort",
    title = "") +
  theme(
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 10),
    legend.position = c(0.2,0.75),
    legend.background = element_rect(colour = "white"),
    legend.box.background = element_rect(colour = "black"),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank(),
    legend.box.margin = margin(t = 1, l = 1, b = 1, r = 1))

ggsave(
  here::here(output_dir_rmd, "figures", "figure_cum_treatment_therapeutics.png"),
  treatment_plot_therapeutics,
  units = "cm", width = 35, height = 20
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_cum_treatment_therapeutics.png"))
```

## Delivery of nMAB and antiviral treatment <a name="delivery"></a>

```{r, eligible-treatment breakdown, echo=FALSE, message=FALSE, warning=FALSE, out.width = '80%'}
table_elig_treat_redacted <- read_csv(fs::path(input_dir_os, "table_elig_treat_redacted.csv")) %>%
    filter(!(High.risk.cohort  %in% c("stem cell transplant recipients", "haematologic malignancy", "haematological diseases", "other")))

table_elig_treat_redacted %>%
  mutate(`Number of treated patients, n (%)` = paste(Number.of.treated.patients, " (",
                                                     round(Number.of.treated.patients/Number.of.eligible.patients*100, digits = 0), ")", 
                                                     sep = ""),
         `Patients treated with Casirivimab, n (%)` = paste(Treated.with.Casirivimab, " (", 
                                                            round(Treated.with.Casirivimab/Number.of.treated.patients*100, digits = 0), ")",
                                                            sep = ""),
         `Patients treated with Molnupiravir, n (%)` = paste(Treated.with.Molnupiravir, " (", 
                                                             round(Treated.with.Molnupiravir/Number.of.treated.patients*100, digits = 0), ")",
                                                             sep = ""),
         `Patients treated with Sotrovimab, n (%)` = paste(Treated.with.Sotrovimab, " (", 
                                                           round(Treated.with.Sotrovimab/Number.of.treated.patients*100, digits = 0), ")", 
                                                           sep = "")) %>%
  select(`High risk cohort` = High.risk.cohort,
         `Number of eligible patients, n` =  Number.of.eligible.patients,
         `Number of treated patients, n (%)`,
          `Patients treated with Casirivimab, n (%)`,
          `Patients treated with Molnupiravir, n (%)`,
          `Patients treated with Sotrovimab, n (%)`) %>%  
  kable(caption = "Table 1: Proportion of eligible patients receiving treatment for COVID-19, broken down by high risk cohort and treatment type", 
        row.names = FALSE, 
        align = c("l", rep("c", 5)),
        booktabs=TRUE, 
        table.attr = "style='width:30%;'") %>%
  kable_styling(position = "center", full_width = F, bootstrap_options = "striped")
```

## Key demographic and clinical characteristics of treated patients <a name="demographic"></a>
The count and rate of eligible patients who had received treatment by `r format(report_stats$study_end, format = "%d-%b-%Y")`, broken down by demographic and clinical categories, is presented in Table 2. 

```{r, echo=FALSE, warning=FALSE, message=FALSE}
table_demo_clinc_breakdown_redacted <- read_csv(fs::path(input_dir_os, "table_demo_clinc_breakdown_redacted.csv"))
colnames(table_demo_clinc_breakdown_redacted) <- c("Group", "Variable", "Count", 
                                                   "Count", "Rate (per 1000 eligible patients)",
                                                   "Count",	"Rate (per 10 treated patients)",
                                                   "Count",	"Rate (per 10 treated patients)",
                                                   "Count",	"Rate (per 10 treated patients)")
table_demo_clinc_breakdown_redacted %>%
  kable(caption = "Table 2: Counts and rates of eligible patients who had received treatment for COVID-19, broken down by demographic and clinical categories", 
        row.names = FALSE, 
        align = c("l", rep("c", 4)),
        booktabs=TRUE, 
        table.attr = "style='width:30%;'") %>%
  kable_styling(position = "center", full_width = F) %>%
  add_header_above(., c(" ", "", "Eligible", "Treated" = 2, "Molnupiravir" = 2, "Sotrovimab" = 2, "Casirivimab" = 2))
```

## Concordance with guidance <a name="concordance"></a>
In addition to the `r format(report_stats$eligible_treated_patients, format = "%d-%b-%Y")` eligible patients who received treatment for COVID-19 between `r format(report_stats$study_start, format = "%d-%b-%Y")` and `r format(report_stats$study_end, format = "%d-%b-%Y")`,  `r format(report_stats$noneligible_treated_patients, format = "%d-%b-%Y")` non-eligible patients also received treatment for COVID-19 within the same time period; `r format(report_stats$noneligible_sotrovimab, format = "%d-%b-%Y")` received sotrovimab, `r format(report_stats$noneligible_molnupiravir, format = "%d-%b-%Y")` received Molnupiravir and `r format(report_stats$noneligible_casirivimab, format = "%d-%b-%Y")` received Casirivimab.

```{r non_elig, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, out.width = '80%', fig.align = 'center', fig.cap = "Figure 3: Breakdown of reasons for treated patients being deemed non-eligible"}
flowchart_non_elig_plot <- flowchart_non_elig %>%
  mutate(base = subset(flowchart_non_elig, criteria == "c0_all")$n,
         n2 = base-n,
         prop = round(n2/base*100, digits = 0)) %>%
  filter(criteria %in% c("c1_alive_and_registered", "c2_has_positive_covid_test", "c3_no_positive_covid_test_previous_30_days",
                         "c4_high_risk_group_nhsd", "c5_no_covid_hospital_admission_last_30_days",
                         "c6_aged_over_12","c7_treated_within_5_days", "c8_not_duplicated_entries")) %>%
  mutate(criteria2 = c("Deregistered from TPP pror to treatment", "No positive SARS-CoV-2 test", "Positive SARS-CoV-2 test in previous 30 days",
                       "No high risk group identified within records", "Hospitalised for COVID in the last 30 days",
                       "Aged under 12 years", "Not treated within 5 days post positive SARS-CoV-2 test", "Duplicated entries")) %>%
  filter(prop > 0) %>%
  ggplot(aes(criteria)) +
  geom_col(aes(x = criteria2, y = prop, fill = criteria)) + 
  theme_classic(base_size = 8) +
  labs(x = "",
       y = "Percentage of non-eligible patients receiving treatment",
       colour = "High risk cohort",
       title = "") +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))

ggsave(
  here::here(output_dir_rmd, "figures", "figure_non_elig_breakdown.png"),
  flowchart_non_elig_plot,
  units = "cm", width = 35, height = 35
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_non_elig_breakdown.png"))
```






## Assessment of high risk patient cohorting <a name="cohorting"></a>

## Time to treatment <a name="time"></a>
```{r, time to treatment, echo=FALSE, warning=FALSE, message=FALSE, fig.show="hold", out.width="50%"}
data_time_between <- read_csv(fs::path(input_dir_os, "table_time_to_treat_redacted.csv")) %>%
  filter(!(high_risk_group_elig %in% c("stem cell transplant recipients", "haematologic malignancy", "haematological diseases", "other")))

data_time_between %>%
  filter(high_risk_group_elig == "All",
         !is.na(tb_postest_treat)) %>%
  ggplot(aes(tb_postest_treat)) +
  geom_col(aes(x = tb_postest_treat, y = n, fill = treatment_type, group = treatment_type), position = "dodge") + 
  theme_classic(base_size = 8) +
  labs(x = "Time between positive SARS-CoV-2 test and treatment for COVID-19 (days)",
       y = "Number of eligible patients receiving treatment",
       colour = "High risk cohort",
       title = "") +
  facet_wrap(~high_risk_group_elig) +
  theme(legend.position = "bottom",
        legend.title = element_blank())

data_time_between %>%
  filter(high_risk_group_elig != "All") %>%
  ggplot(aes(tb_postest_treat)) +
  geom_col(aes(x = tb_postest_treat, y = n)) +
  theme_classic(base_size = 8) +
  labs( x = "Time between positive SARS-CoV-2 test and treatment for COVID-19 (days)",
        y = "Number of patients receiving treatment",
        colour = "High risk cohort",
        title = "") +
  facet_wrap(~high_risk_group_elig, scales = "free_y") +
  theme(legend.position = "none")
```

## COVID-19-related events <a name="events"></a>