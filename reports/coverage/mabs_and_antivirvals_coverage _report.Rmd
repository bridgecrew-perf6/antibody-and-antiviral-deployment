---
title: Coverage and uptake of neutralising monoclonal antibodies or antivirals for non-hospitalised patients with COVID-19
output:
  html_document:
  theme: journal
github_document:
  keep_html: TRUE
---
  
```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}
pre[class] {
  max-height: 200px;
}
```

<style>
  body {
    text-align: justify;
     font-size: 11pt}
</style>

  
$$\\[0.25cm]$$
```{r setup, include=FALSE}
# Document settings ----
knitr::opts_chunk$set(echo = TRUE)

# Import libraries ----
library(tidyverse)
library(here)
library(kableExtra)
library(knitr)
library(ggplot2)
library(png)
library(readr)
library(htmltools)
library(gt)
library(scales)

# Import custom user functions ----
source(here("analysis", "lib", "custom_functions.R"))

# Input directory ----
input_dir_os <- here("released_outputs", "reports", "coverage")
#input_dir_os <- here("output", "reports", "coverage")

# Output directory ----
output_dir_rmd <- here("reports", "coverage")
fs::dir_create(output_dir_rmd)

# Import data ----
report_stats <- read_csv(fs::path(input_dir_os, "table_report_stats_redacted.csv"))
flowchart_non_elig <- read_csv(fs::path(input_dir_os, "table_non_elig_flowchart_redacted.csv")) 
```

# Overview
While vaccines remain the best strategy to prevent COVID-19, recent evidence suggests monoclonal antibodies (nMABs) or antivirals could potentially benefit certain vulnerable populations before or after exposure to SARS-CoV-2, such as the unvaccinated or recently vaccinated high-risk patients. 

With the recent roll out of nMABs and antivirals, there is an urgent need to for knowledge and understanding around the use of nMABs and antivirals in the treatment of patients with COVID-19, such as factors of relevance in determining nMAB and antiviral treatment and the impact of nMAB and antiviral treatment in the community and hospital settings.

This OpenSAFELY report ...

The code and data for this report can be found at the OpenSafely [antibody-and-antiviral-deployment repository](https://github.com/opensafely/antibody-and-antiviral-deployment).


##### Contents
* [Introduction](#intro)
* [Methods](#methods)
* [Results](#results)
  + [Coverage of COVID-19 treatment](#coverage)
  + [Delivery of nMAB and antiviral treatment](#delivery)
  + [Key demographic and clinical characteristics of treated patients](#demographic)
  + [Concordance with guidance](#concordance)
  + [Time to treatment](#time)
  + [COVID-19-related events](#events)


      
# Introduction <a name="intro"></a>
    
    
      
# Methods <a name="methods"></a>
      
      
# Results <a name="results"></a>
      
## Coverage of COVID-19 treatment <a name="coverage"></a>
Between **`r format(report_stats$study_start, format = "%d-%b-%Y")`** and **`r format(report_stats$study_end, format = "%d-%b-%Y")`**, a total of `r format(report_stats$eligible_patients, big.mark = ",", scientific = FALSE)` patients registered at a TPP practice in England were identified as being eligible for receiving a nMABs or antiviral for treating COVID-19 (Figure 1). Within the same time period, a total of `r format(report_stats$treated_patients, big.mark = ",", scientific = FALSE)` patients had received treatment for COVID-19  (Figure 2); `r format(report_stats$treated_sotrovimab, big.mark = ",", scientific = FALSE)` received Sotrovimab, `r format(report_stats$treated_molnupiravir, big.mark = ",", scientific = FALSE)` received Molnupiravir and `r format(report_stats$treated_casirivimab, big.mark = ",", scientific = FALSE)` received Casirivimab.

Note, where appropriate, patients have been included within each relevant high risk cohorts. Out of the `r format(report_stats$eligible_patients, big.mark = ",", scientific = FALSE)` eligible patients, `r format(report_stats$high_risk_cohort_2plus, big.mark = ",", scientific = FALSE)` (`r format(round(report_stats$high_risk_cohort_2plus/report_stats$eligible_patients*100, digits = 0), big.mark = ",", scientific = FALSE)`%) were included in two or more high risk cohorts (range `r report_stats$high_risk_cohort_lower` - `r report_stats$high_risk_cohort_upper`). 

$$\\[0.5cm]$$
```{r, coverage plot, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '100%', fig.align = 'center', fig.cap = "Figure 1: Cumulative total of patients eligible for receiving a nMABs or antiviral for treating COVID-19 since 11th December 2021, stratified by high risk cohort. Note, eligible patients can appear in more than one high risk group and the overall number in each group is likely to be an overestimation due to including patients where their SARS-CoV-2 infection is confirmed by a lateral flow or polymerase chain reaction test."}
coverage_plot_data <- read_csv(here::here(input_dir_os, "table_cum_eligiblity_redacted.csv")) %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immuosupression due to HIV or AIDS (CD4 <350 cells/mm3)", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_))

coverage_plot_data$high_risk_cohort = unlist(lapply(strwrap(coverage_plot_data$high_risk_cohort, width=30, simplify=FALSE), paste, 
                             collapse="\n"))

plot_order <- coverage_plot_data %>%
  group_by(high_risk_cohort) %>%
  mutate(order = max(cum_count_redacted, na.rm = T)) %>%
  arrange(desc(order)) %>%
  filter(cum_count_redacted == order) %>%
  select(high_risk_cohort, order) %>%
  distinct()

coverage_plot_data <- coverage_plot_data %>%
  mutate(high_risk_cohort = factor(high_risk_cohort, levels = plot_order$high_risk_cohort))

coverage_plot <- coverage_plot_data %>%
  ggplot(aes(x = elig_start, y = cum_count_redacted, colour = high_risk_cohort, group = high_risk_cohort)) +
  geom_step(size = 1) +
  theme_classic(base_size = 8) +
  scale_x_date(date_breaks = "1 week", date_labels =  "%d %b %Y") +
  facet_wrap(~high_risk_cohort, scales = "free_y", labeller = labeller(groupwrap = label_wrap_gen(10))) +
  labs(
    x = "",
    y = "Number of patients eligible for receiving treatment",
    colour = "High risk cohort",
    title = "")  +
  theme(legend.position = "none") +
  theme(
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 10),
    strip.text.x = element_text(size = 12)) +
  scale_y_continuous(labels = comma)

ggsave(
  here::here(output_dir_rmd, "figures", "figure_cum_eligiblity.png"),
  coverage_plot,
  units = "cm", width = 35, height = 20
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_cum_eligiblity.png"))

```

$$\\[0.5cm]$$
```{r, elig treatment plot, echo=FALSE, message=FALSE, warning=FALSE, results='asis', fig.width=10, out.width = '90%', fig.align = 'center', fig.cap = "Figure 2: Cumulative total of patients who received a nMABs or antiviral for treating COVID-19 since 11th December 2021, stratified by high risk cohorts. Note, eligible treated patients can appear in more than one high risk group"}
treatment_plot_data_therapeutics <- read_csv(here::here(input_dir_os, "table_cum_treatment_redacted.csv")) %>%
  filter(!is.na(treatment_date),
         treatment_date <= report_stats$study_end + 2) %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immuosupression due to HIV or AIDS (CD4 <350 cells/mm3)", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_))

plot_order <- treatment_plot_data_therapeutics %>%
  group_by(high_risk_cohort) %>%
  mutate(order = max(cum_count_redacted, na.rm = T)) %>%
  arrange(desc(order)) %>%
  filter(cum_count_redacted == order) %>%
  select(high_risk_cohort, order) %>%
  distinct()

treatment_plot_data_therapeutics <- treatment_plot_data_therapeutics %>%
  mutate(high_risk_cohort = factor(high_risk_cohort, levels = plot_order$high_risk_cohort)) 

treatment_plot_therapeutics <- treatment_plot_data_therapeutics %>%
  ggplot(aes(x = treatment_date, y = cum_count_redacted, colour = high_risk_cohort, group = high_risk_cohort)) +
  geom_step(size = 1) +
  theme_classic(base_size = 8) +
  scale_x_date(date_breaks = "1 week", date_labels =  "%d %b %Y") +
  labs(
    x = "Date",
    y = "Number of patients receiving treatment",
    colour = "High risk cohort",
    title = "") +
  theme(
    axis.text = element_text(size = 15),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 12),
    legend.title=element_text(size=12, face = "bold"),
    legend.position = c(0.2,0.75),
    legend.background = element_rect(colour = "white"),
    legend.box.background = element_rect(colour = "black"),
    axis.line.x = element_line(colour = "black"),
    panel.grid.minor.x = element_blank(),
    legend.box.margin = margin(t = 1, l = 1, b = 1, r = 1))

ggsave(
  here::here(output_dir_rmd, "figures", "figure_cum_treatment_therapeutics.png"),
  treatment_plot_therapeutics,
  units = "cm", width = 35, height = 20
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_cum_treatment_therapeutics.png"))
```


## Delivery of nMAB and antiviral treatment <a name="delivery"></a>

```{r, eligible-treatment breakdown, echo=FALSE, message=FALSE, warning=FALSE, out.width = '80%'}
table_elig_treat_redacted <- read_csv(fs::path(input_dir_os, "table_elig_treat_redacted.csv")) %>%
  mutate(high_risk_cohort = case_when(
    high_risk_cohort == "All" ~ "All", 
    high_risk_cohort == "downs_syndrome" ~ "Down's syndrome", 
    high_risk_cohort == "sickle_cell_disease" ~ "Sickle cell disease", 
    high_risk_cohort == "solid_cancer" ~ "Solid cancer", 
    high_risk_cohort == "haematological_disease" ~ "Haematological diseases and stem cell transplant recipients", 
    high_risk_cohort == "renal_disease" ~ "Renal disease", 
    high_risk_cohort == "liver_disease" ~ "Liver disease", 
    high_risk_cohort == "imid" ~ "Immune-mediated inflammatory disorders", 
    high_risk_cohort == "immunosupression" ~ "Primary immune deficiencies", 
    high_risk_cohort == "hiv_aids" ~ "Immuosupression due to HIV or AIDS (CD4 <350 cells/mm3)", 
    high_risk_cohort == "solid_organ_transplant" ~ "Solid organ transplant recipients",
    high_risk_cohort == "rare_neurological_conditions" ~ "Rare neurological conditions",
    TRUE ~ NA_character_)) 

table_elig_treat_redacted %>%
  mutate(`Number of treated patients, %` = round(Treated/Eligibile*100, digits = 0),
         `Casirivimab, n (%)` = paste(Casirivimab, " (", 
                                                            round(Casirivimab/Treated*100, digits = 0), ")",
                                                            sep = ""),
         `Molnupiravir, n (%)` = paste(Molnupiravir, " (", 
                                                             round(Molnupiravir/Treated*100, digits = 0), ")",
                                                             sep = ""),
         `Sotrovimab, n (%)` = paste(Sotrovimab, " (", 
                                                           round(Sotrovimab/Treated*100, digits = 0), ")", 
                                                           sep = "")) %>%
  select(`High risk cohort` = high_risk_cohort,
         n =  Eligibile,
         `All, n` = Treated,
         `All, %` = `Number of treated patients, %`,
          `Sotrovimab, n (%)`,
          `Molnupiravir, n (%)`,
          `Casirivimab, n (%)`
          ) %>%  
  mutate(`Casirivimab, n (%)` = ifelse(`Casirivimab, n (%)` == "NA (NA)", "<5", `Casirivimab, n (%)`)) %>%
  kable(caption = "Table 1: Proportion of patients receiving treatment for COVID-19, broken down by high risk cohort and treatment type", 
        row.names = FALSE, 
        align = c("l", rep("c", 6)),
        booktabs=TRUE, 
        table.attr = "style='width:30%;'") %>%
  kable_styling(position = "center", full_width = F, bootstrap_options = "striped")  %>%
  add_header_above(., c(" ", "Eligible patients", "Treated Patients" = 5))
```

## Key demographic and clinical characteristics of treated patients <a name="demographic"></a>
Table 2 shows the number and proportion of patients who had received treatment by `r format(report_stats$study_end, format = "%d-%b-%Y")`, broken down by demographic and clinical categories and treatment type. 

```{r, echo=FALSE, warning=FALSE, message=FALSE}
table_demo_clinc_breakdown_redacted <- read_csv(fs::path(input_dir_os, "table_demo_clinc_breakdown_redacted.csv"))
colnames(table_demo_clinc_breakdown_redacted) <- c("Group", "Variable", "Count", 
                                                   "Count", "%",
                                                   "Count",	"%",
                                                   "Count",	"%",
                                                   "Count",	"%")
table_demo_clinc_breakdown_redacted %>%
  kable(caption = "Table 2: Count and proportion of patients who had received treatment for COVID-19, broken down by demographic and clinical categories", 
        row.names = FALSE, 
        align = c("l", rep("c", 4)),
        booktabs=TRUE, 
        table.attr = "style='width:30%;'") %>%
  kable_styling(position = "center", full_width = F, bootstrap_options = "striped")  %>%
  add_header_above(., c(" ", "", "Eligible", "All" = 2, "Molnupiravir" = 2, "Sotrovimab" = 2, "Casirivimab" = 2)) %>%
  add_header_above(., c(" ", "", "", "Treated" = 8))
```

## Concordance with guidance <a name="concordance"></a>
Of the `r format(report_stats$treated_patients, format = "%d-%b-%Y")` patients who received treatment for COVID-19 between `r format(report_stats$study_start, format = "%d-%b-%Y")` and `r format(report_stats$study_end, format = "%d-%b-%Y")`,  `r format(report_stats$non_eligible_patients, big.mark = ",", scientific = FALSE)` patients were missing records needed to confirm eligibility. It is likely that most, if not all, of these patients meet all of the eligibility criteria and non of the exclusion criteria but, for example, their SARS-CoV-2 test result is not available in their record or we just do not have access to all the criteria the clinician might use to assess high risk group status (such as the patients identified via non digital methods).

```{r non_elig, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, out.width = '80%', fig.align = 'center', fig.cap = "Figure 3: Breakdown of eligibility criteria variables in treated patients with missing records needed to confirm eligibility"}
flowchart_non_elig_plot <- flowchart_non_elig %>%
  mutate(criteria2 = c("High risk cohort identified within records but does not match treatment high risk cohort",
                       "Not treated within 5 days post positive SARS-CoV-2 test",
                       "No positive SARS-CoV-2 test record",
                       "Required hospitalisation within 30 days prior to treatment with COVID-19 recorded as the primary diagnosis",
                       "No high risk cohort identified within records",
                       "Positive SARS-CoV-2 test record in previous 30 days")) 

flowchart_non_elig_plot$criteria2 = unlist(lapply(strwrap(flowchart_non_elig_plot$criteria2, width=30, simplify=FALSE), paste, 
                                                  collapse="\n"))

flowchart_non_elig_plot <- flowchart_non_elig_plot %>%
  mutate(criteria2 = factor(criteria2, levels = unique(flowchart_non_elig_plot$criteria2)))

flowchart_non_elig_plot <- flowchart_non_elig_plot %>%
  ggplot(aes(criteria)) +
  geom_col(aes(x = criteria2, y = n, fill = criteria)) + 
  theme_classic(base_size = 8) +
  labs(x = "",
       y = "Percentage of non-eligible patients receiving treatment",
       colour = "High risk cohort",
       title = "") +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))

ggsave(
  here::here(output_dir_rmd, "figures", "figure_non_elig_breakdown.png"),
  flowchart_non_elig_plot,
  units = "cm", width = 35, height = 35
)

include_graphics(fs::path(output_dir_rmd, "figures", "figure_non_elig_breakdown.png"))
```

## Time to treatment <a name="time"></a>
```{r time to treatment, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=10, out.width = '80%', fig.align = 'center', fig.cap = "Figure 4: Time between positive SARS-CoV-2 test and treatment for COVID-19, broken down by treatment type"}
data_time_between <- read_csv(fs::path(input_dir_os, "table_time_to_treat_redacted.csv"))

data_time_between %>%
  filter(high_risk_group_elig == "All",
         !is.na(tb_postest_treat),
         !is.na(n),
         tb_postest_treat < 15) %>%
  ggplot(aes(tb_postest_treat)) +
  geom_col(aes(x = tb_postest_treat, y = n, fill = treatment_type, group = treatment_type), position = "dodge") + 
  theme_bw(base_size = 8) +
  facet_wrap(~treatment_type, ncol = 3) +
  theme(legend.position = "none") +
  labs(x = "Time between positive SARS-CoV-2 test and treatment for COVID-19 (days)",
       y = "Number of patients receiving treatment",
       colour = "High risk cohort",
       title = "") +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```


## COVID-19-related events <a name="events"></a>
```{r, echo=FALSE, warning=FALSE, message=FALSE}
table_outcomes <- read_csv(fs::path(input_dir_os, "table_covid_outcomes_redacted.csv"))
colnames(table_outcomes) <- c("Outcome", 
                                                   "Count", "%",
                                                   "Count",	"%",
                                                   "Count",	"%",
                                                   "Count",	"%")
table_outcomes %>%
  kable(caption = "Table 4: Count and proportion of patients with COVID-19 outcomes", 
        row.names = FALSE, 
        align = c("l", rep("c", 4)),
        booktabs=TRUE, 
        table.attr = "style='width:30%;'") %>%
  kable_styling(position = "center", full_width = F, bootstrap_options = "striped")  %>%
  add_header_above(., c(" ", "Un-treated" = 2, "Treated" = 2))
```